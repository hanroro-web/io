<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한로로 관리자 대시보드 | Fix Applied</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // 1. 초기 설정 보호 로직
        let db, auth, appId;
        let isAuthReady = false;

        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'hanroro-web-app';
        } catch (err) {
            console.error("Firebase Config Error:", err);
        }

        // 2. 인증 로직 강화 (로그인 완료 전까지 쓰기 차단)
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth Initialization Failed:", e);
                showToast("인증 서버 연결 실패");
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                isAuthReady = true;
                document.getElementById('auth-status').innerText = "CONNECTED";
                document.getElementById('auth-status').classList.replace('text-yellow-500', 'text-green-400');
                setupRealtimeListener();
            }
        });

        initAuth();

        // 3. 실시간 리스너 (경로: artifacts / appId / public / data / notices)
        function setupRealtimeListener() {
            const noticeCol = collection(db, 'artifacts', appId, 'public', 'data', 'notices');
            
            onSnapshot(noticeCol, (snapshot) => {
                const listElement = document.getElementById('notice-history');
                let notices = [];
                snapshot.forEach(doc => notices.push({ id: doc.id, ...doc.data() }));
                
                // 최신순 정렬 (Rule 2 준수: 인덱스 없이 메모리 정렬)
                notices.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                let html = '';
                notices.forEach(notice => {
                    const date = notice.createdAt ? new Date(notice.createdAt.seconds * 1000).toLocaleString() : '방금 전';
                    html += `
                        <div class="p-4 bg-white/5 border border-white/10 rounded-2xl mb-3 flex justify-between items-center group">
                            <div class="flex-1 pr-4 overflow-hidden">
                                <p class="text-white text-sm font-medium break-all">${notice.text}</p>
                                <p class="text-gray-500 text-[10px] mt-1"><i class="far fa-clock mr-1"></i>${date}</p>
                            </div>
                            <button onclick="deleteNotice('${notice.id}')" class="shrink-0 w-8 h-8 flex items-center justify-center rounded-lg bg-red-500/10 text-red-500 opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-opacity hover:bg-red-500 hover:text-white">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                    `;
                });
                listElement.innerHTML = html || '<div class="text-gray-600 text-center py-20 text-xs">내역이 없습니다.</div>';
            }, (error) => {
                console.error("Snapshot Error:", error);
            });
        }

        // 4. 삭제 함수 (Rule 1 & 3 준수)
        window.deleteNotice = async (docId) => {
            if (!isAuthReady) return showToast("인증 대기 중...");
            if (!confirm("삭제하시겠습니까?")) return;
            
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'notices', docId);
                await deleteDoc(docRef);
                showToast("삭제 완료");
            } catch (e) {
                console.error("Delete Fail:", e);
                showToast("삭제 권한이 없습니다.");
            }
        };

        // 5. 전송 함수 (Rule 1 & 3 준수)
        window.sendNotice = async () => {
            if (!isAuthReady) {
                showToast("인증 세션 연결 중입니다...");
                return;
            }

            const input = document.getElementById('notice-input');
            const text = input.value.trim();
            const btn = document.getElementById('submit-btn');

            if (!text) {
                showToast("내용을 입력하세요.");
                return;
            }

            try {
                btn.disabled = true;
                btn.innerText = "처리 중...";
                
                const noticeCol = collection(db, 'artifacts', appId, 'public', 'data', 'notices');
                await addDoc(noticeCol, {
                    text: text,
                    createdAt: serverTimestamp(),
                    uid: auth.currentUser.uid
                });
                
                input.value = "";
                showToast("배포 성공");
            } catch (e) {
                console.error("Write Fail:", e);
                showToast("전송 오류: " + e.code);
            } finally {
                btn.disabled = false;
                btn.innerText = "공지 등록 및 즉시 배포";
            }
        };

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background: #05020a; color: white; -webkit-font-smoothing: antialiased; }
        .glass-card { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .purple-glow { box-shadow: 0 0 40px rgba(138, 79, 255, 0.1); }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-5xl mx-auto px-6 py-10">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-xl font-black text-white flex items-center">
                    <span class="w-2 h-2 bg-purple-600 mr-2 rounded-full"></span>
                    ADMIN PANEL
                </h1>
            </div>
            <div id="auth-status" class="text-[10px] font-bold text-yellow-500 tracking-widest bg-white/5 px-4 py-2 rounded-full">
                AUTHENTICATING...
            </div>
        </header>

        <div class="grid lg:grid-cols-2 gap-8">
            <div class="glass-card rounded-[2rem] p-8 purple-glow h-fit">
                <h2 class="font-bold mb-6 text-purple-400">새 공지 등록</h2>
                <textarea id="notice-input" rows="4" 
                    class="w-full bg-white/5 border border-white/10 p-5 rounded-2xl text-sm focus:border-purple-600 outline-none transition-all mb-4" 
                    placeholder="여기에 내용을 입력하세요..."></textarea>
                <button id="submit-btn" onclick="sendNotice()" 
                    class="w-full bg-purple-600 hover:bg-purple-700 py-4 rounded-xl font-bold text-sm transition-all shadow-lg shadow-purple-900/20">
                    공지 등록 및 즉시 배포
                </button>
            </div>

            <div class="glass-card rounded-[2rem] p-8 flex flex-col max-h-[600px]">
                <h2 class="font-bold mb-6 text-gray-400">최근 배포 이력</h2>
                <div id="notice-history" class="overflow-y-auto flex-1 pr-2">
                    <div class="text-center py-20 opacity-20">로딩 중...</div>
                </div>
            </div>
        </div>

        <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-white text-black px-8 py-3 rounded-full font-bold text-[10px] opacity-0 transition-opacity duration-300 shadow-2xl pointer-events-none z-50">
            알림
        </div>
    </div>
</body>
</html>
