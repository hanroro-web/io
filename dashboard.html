<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한로로 대시보드 | 통합 관리 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@100..900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background: #05020a; color: #fff; margin: 0; padding: 0; }
        
        .sidebar { background: #0c051a; border-right: 1px solid rgba(138, 79, 255, 0.1); }
        .card { background: #0f0a1f; border: 1px solid rgba(138, 79, 255, 0.1); border-radius: 1rem; transition: all 0.2s; }
        .card:hover { border-color: rgba(138, 79, 255, 0.3); }
        
        .input-field { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.75rem; padding: 0.75rem 1rem; color: #fff; outline: none; width: 100%; font-size: 0.9rem; }
        .input-field:focus { border-color: #8a4fff; background: rgba(138, 79, 255, 0.12); }
        
        .btn-primary { background: #8a4fff; color: #fff; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 700; transition: all 0.2s; cursor: pointer; border: none; }
        .btn-primary:hover { background: #7a3fff; transform: translateY(-1px); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-item { cursor: pointer; transition: all 0.2s; }
        .nav-item.active { background: rgba(138, 79, 255, 0.1); color: #8a4fff; }
        
        .modal { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        .modal-body { background: #161129; border: 1px solid rgba(138, 79, 255, 0.2); border-radius: 1.5rem; width: 100%; max-width: 500px; padding: 2rem; position: relative; }
        
        #auth-status-bar { position: fixed; top: 1rem; right: 1rem; padding: 0.5rem 1rem; border-radius: 2rem; font-size: 10px; font-weight: bold; z-index: 50; }
        .status-online { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); }
        .status-loading { background: rgba(255, 255, 255, 0.05); color: #94a3b8; border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="min-h-screen flex overflow-hidden">

    <div id="auth-status-bar" class="status-loading">
        <i class="fas fa-spinner fa-spin mr-1"></i> CONNECTING...
    </div>

    <!-- 사이드바 -->
    <aside class="sidebar w-64 flex-shrink-0 flex flex-col">
        <div class="p-6">
            <div class="flex items-center space-x-2 mb-10">
                <i class="fas fa-magic text-purple-500"></i>
                <span class="text-xl font-black tracking-tighter uppercase">HANRORO CMS</span>
            </div>
            <nav class="space-y-1">
                <div onclick="switchTab('projects')" class="nav-item active w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-sm font-bold text-gray-400" id="nav-projects">
                    <i class="fas fa-tasks w-5"></i><span>프로젝트 관리</span>
                </div>
                <div onclick="switchTab('payments')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-sm font-bold text-gray-400" id="nav-payments">
                    <i class="fas fa-wallet w-5"></i><span>입금 현황</span>
                </div>
                <div onclick="switchTab('quotes')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-sm font-bold text-gray-400" id="nav-quotes">
                    <i class="fas fa-file-invoice-dollar w-5"></i><span>견적 신청 내역</span>
                </div>
                <div onclick="switchTab('consultations')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-sm font-bold text-gray-400" id="nav-consultations">
                    <i class="fas fa-comments w-5"></i><span>상담 신청 내역</span>
                </div>
                <div onclick="switchTab('notices')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-sm font-bold text-gray-400" id="nav-notices">
                    <i class="fas fa-bullhorn w-5"></i><span>공지사항 관리</span>
                </div>
            </nav>
        </div>
    </aside>

    <main class="flex-grow overflow-y-auto p-8 lg:p-12">
        <header class="flex justify-between items-end mb-10">
            <div>
                <h1 class="text-3xl font-black mb-2" id="page-title">프로젝트 관리</h1>
                <p class="text-gray-500 text-sm" id="page-desc">실시간으로 프로젝트 진행 상태를 업데이트합니다.</p>
            </div>
            <button id="add-btn" class="btn-primary flex items-center gap-2">
                <i class="fas fa-plus"></i><span>새로 등록</span>
            </button>
        </header>

        <div id="tab-projects" class="tab-content active"><div id="project-list" class="grid gap-4 sm:grid-cols-2"></div></div>
        <div id="tab-payments" class="tab-content"><div id="payment-list" class="grid gap-4"></div></div>
        <div id="tab-quotes" class="tab-content"><div id="quote-list" class="grid gap-4"></div></div>
        <div id="tab-consultations" class="tab-content"><div id="consultation-list" class="grid gap-4"></div></div>
        <div id="tab-notices" class="tab-content"><div id="notice-list" class="grid gap-4"></div></div>
    </main>

    <div id="crud-modal" class="modal">
        <div class="modal-body">
            <h2 id="modal-title" class="text-xl font-black mb-6">데이터 등록</h2>
            <form id="crud-form" class="space-y-4">
                <div id="form-fields" class="space-y-4"></div>
                <div class="flex gap-2 pt-4">
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-800 text-white py-3 rounded-xl font-bold">취소</button>
                    <button type="submit" id="submit-btn" class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-bold">저장하기</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        
        const firebaseConfig = { 
            apiKey: "AIzaSyBkWgHnnHTKaOfHmgt7P-OwptraKcwEXvI", 
            authDomain: "hanroro-web.firebaseapp.com", 
            projectId: "hanroro-web", 
            appId: "1:461514865624:web:4ab6ad23c2e771b426d0ad" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "hanroro-official-service";

        let currentTab = 'projects';
        let editingId = null;

        const config = {
            projects: {
                collection: 'projects',
                title: '프로젝트 관리',
                desc: '실시간으로 프로젝트 진행 상태를 업데이트합니다.',
                fields: [
                    { id: 'name', label: '프로젝트명', type: 'text', placeholder: '예: 한로로 공식 웹사이트' },
                    { id: 'phase', label: '현재 단계', type: 'text', placeholder: '예: 디자인 검토 중' },
                    { id: 'progress', label: '진행률 (%)', type: 'number', placeholder: '0-100' }
                ],
                render: (id, d) => `
                    <div class="card p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-bold text-lg">${d.name}</h4>
                                <p class="text-xs text-purple-400 mt-1">${d.phase}</p>
                            </div>
                            <div class="text-2xl font-black text-purple-500">${d.progress}%</div>
                        </div>
                        <div class="flex gap-3 border-t border-white/5 pt-4">
                            <button onclick="window.openEdit('${id}', '${encodeURIComponent(JSON.stringify(d))}')" class="text-xs font-bold text-gray-500 hover:text-white">수정</button>
                            <button onclick="window.deleteItem('${id}')" class="text-xs font-bold text-gray-500 hover:text-red-500">삭제</button>
                        </div>
                    </div>`
            },
            payments: {
                collection: 'deposits',
                title: '입금 현황',
                desc: '실시간 입금 확인 내역을 관리합니다.',
                fields: [
                    { id: 'name', label: '입금자명', type: 'text' },
                    { id: 'type', label: '항목', type: 'text', placeholder: '예: 홈페이지 잔금' },
                    { id: 'amount', label: '금액', type: 'number' },
                    { id: 'status', label: '상태', type: 'select', options: [{v:'waiting', l:'확인 중'}, {v:'complete', l:'입금 완료'}] }
                ],
                render: (id, d) => `
                    <div class="card p-5 flex justify-between items-center">
                        <div>
                            <h4 class="font-bold">${d.name}</h4>
                            <p class="text-[10px] text-gray-500 mt-1 uppercase">${d.type}</p>
                        </div>
                        <div class="flex items-center gap-6">
                            <div class="text-right">
                                <div class="font-black text-white">₩${Number(d.amount).toLocaleString()}</div>
                                <span class="text-[10px] font-bold ${d.status === 'complete' ? 'text-emerald-500' : 'text-amber-500'}">
                                    ${d.status === 'complete' ? '입금 완료' : '입금 확인 중'}
                                </span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="window.openEdit('${id}', '${encodeURIComponent(JSON.stringify(d))}')" class="p-2 text-gray-600 hover:text-white"><i class="fas fa-edit"></i></button>
                                <button onclick="window.deleteItem('${id}')" class="p-2 text-gray-600 hover:text-red-500"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>`
            },
            notices: {
                collection: 'settings',
                title: '공지사항 관리',
                desc: '메인 페이지 하단 띠 배너에 표시될 내용을 관리합니다.',
                fields: [{ id: 'content', label: '공지 문구', type: 'text', placeholder: '이벤트 내용을 입력하세요' }],
                render: (id, d) => `
                    <div class="card p-6 flex justify-between items-center">
                        <p class="text-sm text-gray-300 font-medium">${d.content}</p>
                        <div class="flex gap-2">
                            <button onclick="window.openEdit('${id}', '${encodeURIComponent(JSON.stringify(d))}')" class="p-2 text-gray-600 hover:text-white"><i class="fas fa-edit"></i></button>
                            <button onclick="window.deleteItem('${id}')" class="p-2 text-gray-600 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`
            },
            quotes: {
                collection: 'quotes',
                title: '견적 신청 내역',
                desc: '홈페이지에서 신청된 프로젝트 견적 문의 목록입니다.',
                render: (id, d) => `
                    <div class="card p-6">
                        <div class="flex justify-between mb-4">
                            <h4 class="font-bold text-white">${d.name} <span class="text-[10px] text-purple-400 bg-purple-400/10 px-2 py-0.5 rounded ml-2">${d.phone || d.contact || '연락처 없음'}</span></h4>
                            <button onclick="window.deleteItem('${id}')" class="text-gray-600 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="bg-black/30 p-4 rounded-xl text-xs text-gray-400 leading-relaxed">
                            <div class="mb-2"><span class="text-gray-500 font-bold">TYPE:</span> ${d.type || '미지정'} / <span class="text-gray-500 font-bold">BUDGET:</span> ${d.budget || '협의'}</div>
                            <div class="whitespace-pre-wrap">${d.memo || '내용 없음'}</div>
                        </div>
                    </div>`
            },
            consultations: {
                collection: 'consultations',
                title: '상담 신청 내역',
                desc: '홈페이지 하단 혹은 모달을 통해 접수된 간단 상담 문의입니다.',
                render: (id, d) => `
                    <div class="card p-6">
                        <div class="flex justify-between mb-4">
                            <div>
                                <h4 class="font-bold text-white">${d.name || '익명 고객'}</h4>
                                <p class="text-[11px] text-emerald-400 font-bold mt-1"><i class="fas fa-phone-alt mr-1"></i> ${d.phone || d.contact || '연락처 미기재'}</p>
                            </div>
                            <button onclick="window.deleteItem('${id}')" class="text-gray-600 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="bg-black/30 p-4 rounded-xl text-xs text-gray-400 leading-relaxed">
                            <div class="mb-1 text-gray-300 font-bold">${d.subject || '상담 요청'}</div>
                            <div class="whitespace-pre-wrap">${d.memo || '신청 내용이 없습니다.'}</div>
                        </div>
                    </div>`
            }
        };

        window.switchTab = (tabId) => {
            currentTab = tabId;
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`nav-${tabId}`).classList.add('active');
            
            const info = config[tabId] || { title: '관리', desc: '데이터를 확인합니다.' };
            document.getElementById('page-title').innerText = info.title;
            document.getElementById('page-desc').innerText = info.desc;
            document.getElementById('add-btn').style.visibility = (tabId === 'quotes' || tabId === 'consultations') ? 'hidden' : 'visible';
        };

        const openModal = (isEdit = false, data = null) => {
            const modal = document.getElementById('crud-modal');
            const formFields = document.getElementById('form-fields');
            const title = document.getElementById('modal-title');
            
            formFields.innerHTML = '';
            editingId = isEdit ? data.id : null;
            title.innerText = isEdit ? '데이터 수정' : '새로운 데이터 등록';

            const fields = config[currentTab]?.fields || [];
            fields.forEach(f => {
                let html = `<div><label class="block text-[11px] font-bold text-purple-400 uppercase mb-2 ml-1">${f.label}</label>`;
                if (f.type === 'select') {
                    html += `<select name="${f.id}" class="input-field">` + f.options.map(o => `<option value="${o.v}" ${data && data[f.id] === o.v ? 'selected' : ''}>${o.l}</option>`).join('') + `</select>`;
                } else if (f.type === 'textarea') {
                    html += `<textarea name="${f.id}" class="input-field h-32" placeholder="${f.placeholder || ''}">${data ? data[f.id] : ''}</textarea>`;
                } else {
                    html += `<input type="${f.type}" name="${f.id}" value="${data ? data[f.id] : ''}" class="input-field" placeholder="${f.placeholder || ''}" required>`;
                }
                html += `</div>`;
                formFields.innerHTML += html;
            });
            modal.classList.add('active');
        };

        window.closeModal = () => {
            document.getElementById('crud-modal').classList.remove('active');
            document.getElementById('crud-form').reset();
        };

        window.openEdit = (id, jsonStr) => {
            const data = JSON.parse(decodeURIComponent(jsonStr));
            openModal(true, { id, ...data });
        };

        window.deleteItem = async (id) => {
            if (!confirm('정말 삭제하시겠습니까?')) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', config[currentTab].collection, id));
            } catch (e) { alert('삭제 실패: ' + e.message); }
        };

        document.getElementById('crud-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.disabled = true; btn.innerText = "처리 중...";
            
            const formData = new FormData(e.target);
            const payload = { updatedAt: serverTimestamp() };
            formData.forEach((value, key) => payload[key] = value);

            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', config[currentTab].collection);
                if (editingId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', config[currentTab].collection, editingId), payload);
                } else {
                    await addDoc(colRef, { ...payload, createdAt: serverTimestamp() });
                }
                closeModal();
            } catch (err) {
                alert('저장 실패: ' + err.message);
            } finally {
                btn.disabled = false; btn.innerText = "저장하기";
            }
        };

        document.getElementById('add-btn').onclick = () => openModal();

        const initRealtime = () => {
            const listMappings = { projects: 'project-list', payments: 'payment-list', quotes: 'quote-list', consultations: 'consultation-list', notices: 'notice-list' };
            Object.keys(config).forEach(tabKey => {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', config[tabKey].collection);
                onSnapshot(colRef, (snap) => {
                    const listEl = document.getElementById(listMappings[tabKey]);
                    if (!listEl) return;
                    
                    const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    // 정렬: 최신순
                    docs.sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));

                    if (docs.length === 0) {
                        listEl.innerHTML = `<div class="col-span-full py-20 text-center text-gray-600 text-sm">등록된 내역이 없습니다.</div>`;
                    } else {
                        listEl.innerHTML = docs.map(d => config[tabKey].render(d.id, d)).join('');
                    }
                }, (err) => console.error(`${tabKey} error:`, err));
            });
            // 접속 완료 표시
            const status = document.getElementById('auth-status-bar');
            status.className = 'status-online';
            status.innerHTML = '<i class="fas fa-circle text-[8px] mr-1"></i> SYSTEM ONLINE';
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) { initRealtime(); } 
            else { await signInAnonymously(auth); }
        });
    </script>
</body>
</html>
