<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한로로 대시보드 | 관리 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@100..900&display=swap');
        
        body { 
            font-family: 'Pretendard', sans-serif; 
            background: #05020a; 
            color: #fff; 
            margin: 0; 
            padding: 0;
            /* 보안을 위한 선택 방지이나, 입력 폼에는 영향을 주지 않도록 설정 */
            user-select: none; 
            -webkit-user-select: none;
        }
        
        /* 입력 필드 강제 활성화 설정 (가장 중요) */
        input, textarea, select {
            user-select: text !important;
            -webkit-user-select: text !important;
            pointer-events: auto !important;
            cursor: text !important;
        }

        .sidebar { background: #0c051a; border-right: 1px solid rgba(138, 79, 255, 0.1); }
        .card { background: #0f0a1f; border: 1px solid rgba(138, 79, 255, 0.1); border-radius: 1rem; transition: all 0.2s; }
        .card:hover { border-color: rgba(138, 79, 255, 0.3); }
        
        .input-field { 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 0.75rem; 
            padding: 0.75rem 1rem; 
            color: #fff; 
            outline: none; 
            transition: all 0.2s; 
            width: 100%;
            font-size: 1rem;
        }
        .input-field:focus { 
            border-color: #8a4fff; 
            background: rgba(138, 79, 255, 0.12); 
            box-shadow: 0 0 0 2px rgba(138, 79, 255, 0.2);
        }
        
        .btn-primary { background: #8a4fff; color: #fff; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 700; transition: all 0.2s; cursor: pointer; border: none; }
        .btn-primary:hover { background: #7c3aed; transform: translateY(-1px); }
        
        #auth-overlay { 
            position: fixed; 
            inset: 0; 
            z-index: 9999; 
            background: #05020a; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-item.active { background: rgba(138, 79, 255, 0.1); color: #8a4fff; }

        .modal { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        .modal-body { background: #161129; border: 1px solid rgba(138, 79, 255, 0.2); border-radius: 1.5rem; width: 100%; max-width: 500px; padding: 2rem; position: relative; }

        /* 애니메이션 */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex overflow-hidden">

    <!-- 로그인 오버레이 -->
    <div id="auth-overlay">
        <div class="card p-10 w-full max-w-md mx-4 shadow-2xl border-purple-500/20 fade-in">
            <div class="text-center mb-8">
                <i class="fas fa-magic text-4xl text-purple-500 mb-4"></i>
                <h2 class="text-2xl font-black uppercase tracking-tighter italic">HANRORO CMS</h2>
                <p class="text-gray-500 text-[10px] mt-2 uppercase tracking-widest text-center">Administrator Only</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-gray-500 font-bold uppercase ml-1 mb-1 block">ID</label>
                    <input type="text" id="auth-id" class="input-field" placeholder="아이디 입력" autocomplete="off">
                </div>
                <div>
                    <label class="text-[10px] text-gray-500 font-bold uppercase ml-1 mb-1 block">Password</label>
                    <input type="password" id="auth-pw" class="input-field" placeholder="비밀번호 입력" autocomplete="off">
                </div>
                <button type="button" id="login-submit-btn" class="btn-primary w-full mt-4">대시보드 접속</button>
            </div>
            <div id="login-error" class="text-red-500 text-[10px] mt-4 text-center hidden font-bold">로그인 정보가 올바르지 않습니다.</div>
        </div>
    </div>

    <!-- 사이드바 -->
    <aside id="main-sidebar" class="sidebar w-64 flex-shrink-0 flex flex-col hidden">
        <div class="p-6">
            <div class="flex items-center space-x-2 mb-10">
                <i class="fas fa-magic text-purple-500"></i>
                <span class="text-xl font-black tracking-tighter uppercase">HANRORO</span>
            </div>
            <nav class="space-y-1">
                <button onclick="switchTab('projects')" class="nav-item active w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all text-sm font-bold text-gray-400" id="nav-projects">
                    <i class="fas fa-tasks w-5"></i><span>프로젝트 관리</span>
                </button>
                <button onclick="switchTab('payments')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all text-sm font-bold text-gray-400" id="nav-payments">
                    <i class="fas fa-wallet w-5"></i><span>입금 현황</span>
                </button>
                <button onclick="switchTab('inquiries')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all text-sm font-bold text-gray-400" id="nav-inquiries">
                    <i class="fas fa-comment-alt w-5"></i><span>견적/상담 신청</span>
                </button>
                <button onclick="switchTab('notices')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all text-sm font-bold text-gray-400" id="nav-notices">
                    <i class="fas fa-bullhorn w-5"></i><span>공지사항 관리</span>
                </button>
                <button id="logout-btn" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-red-500/10 transition-all text-gray-500 hover:text-red-400 mt-10">
                    <i class="fas fa-sign-out-alt w-5"></i><span class="text-sm font-bold">로그아웃</span>
                </button>
            </nav>
        </div>
    </aside>

    <main id="main-content" class="flex-grow overflow-y-auto p-8 lg:p-12 hidden">
        <header class="flex justify-between items-end mb-10">
            <div>
                <h1 class="text-3xl font-black mb-2" id="page-title">프로젝트 관리</h1>
                <p class="text-gray-500 text-sm" id="page-desc">실시간 데이터를 관리합니다.</p>
            </div>
            <button id="add-btn" class="btn-primary flex items-center gap-2">
                <i class="fas fa-plus"></i><span>새로 등록</span>
            </button>
        </header>

        <div id="tab-projects" class="tab-content active"><div id="project-list" class="grid gap-4 sm:grid-cols-2"></div></div>
        <div id="tab-payments" class="tab-content"><div id="payment-list" class="grid gap-4"></div></div>
        <div id="tab-inquiries" class="tab-content"><div id="inquiry-list" class="grid gap-4"></div></div>
        <div id="tab-notices" class="tab-content"><div id="notice-list" class="grid gap-4"></div></div>
    </main>

    <!-- CRUD 모달 -->
    <div id="crud-modal" class="modal">
        <div class="modal-body">
            <h3 id="modal-title" class="text-xl font-black mb-6">데이터 편집</h3>
            <form id="crud-form" class="space-y-4">
                <input type="hidden" id="target-id">
                <div id="form-fields" class="space-y-4"></div>
                <div class="flex gap-2 mt-8">
                    <button type="button" onclick="closeModal()" class="w-1/2 p-4 rounded-xl font-bold text-gray-500 hover:bg-white/5 transition-all">취소</button>
                    <button type="submit" class="btn-primary w-1/2">저장하기</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        
        const firebaseConfig = { 
            apiKey: "AIzaSyBkWgHnnHTKaOfHmgt7P-OwptraKcwEXvI", 
            authDomain: "hanroro-web.firebaseapp.com", 
            projectId: "hanroro-web", 
            appId: "1:461514865624:web:4ab6ad23c2e771b426d0ad" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "hanroro-official-service";

        let currentTab = 'projects';

        const config = {
            projects: {
                collection: 'projects',
                fields: [{ id: 'name', label: '프로젝트명', type: 'text' }, { id: 'phase', label: '현재 단계', type: 'text' }, { id: 'progress', label: '진행률 (%)', type: 'number' }],
                render: (id, d) => `<div class="card p-6 border-white/5"><div class="flex justify-between items-start mb-4"><div><h4 class="font-bold text-lg text-white">${d.name || '무제'}</h4><p class="text-xs text-purple-400 mt-1">${d.phase || '-'}</p></div><div class="text-2xl font-black text-purple-500">${d.progress || 0}%</div></div><div class="flex gap-2"><button onclick="openEdit('projects', '${id}', '${encodeURIComponent(JSON.stringify(d))}')" class="text-[11px] font-bold text-gray-500 hover:text-white transition-all uppercase">Edit</button> <span class="text-gray-800">|</span> <button onclick="deleteItem('projects', '${id}')" class="text-[11px] font-bold text-gray-500 hover:text-red-500 transition-all uppercase">Delete</button></div></div>`
            },
            payments: {
                collection: 'deposits',
                fields: [{ id: 'name', label: '입금자명', type: 'text' }, { id: 'amount', label: '금액', type: 'number' }, { id: 'status', label: '입금 상태', type: 'select', options: [{ value: 'waiting', label: '입금 대기' }, { value: 'complete', label: '입금 완료' }] }],
                render: (id, d) => `<div class="card p-6 flex justify-between items-center border-white/5"><div><h4 class="font-bold text-white">${d.name || '익명'}</h4><p class="text-[10px] text-gray-500 uppercase mt-1">${d.type || '서비스'}</p></div><div class="flex items-center gap-6"><div class="text-right"><div class="font-black text-green-400">₩${Number(d.amount || 0).toLocaleString()}</div><span class="text-[10px] uppercase font-bold ${d.status === 'complete' ? 'text-green-500' : 'text-yellow-500'}">${d.status === 'complete' ? '입금 완료' : '입금 대기'}</span></div><button onclick="openEdit('payments', '${id}', '${encodeURIComponent(JSON.stringify(d))}')" class="p-2 text-gray-500 hover:text-white"><i class="fas fa-edit"></i></button></div></div>`
            },
            inquiries: {
                collection: 'quotes',
                render: (id, d) => `<div class="card p-6 border-white/5"><div class="flex justify-between items-start mb-4"><div><h4 class="font-bold text-white">${d.name || '이름 없음'} <span class="text-xs font-normal text-gray-500 ml-2">${d.phone || '-'}</span></h4><p class="text-[10px] text-purple-400 font-black mt-1 uppercase">${d.type || '일반'}</p></div><button onclick="deleteItem('inquiries', '${id}')" class="p-2 text-gray-600 hover:text-red-500"><i class="fas fa-trash"></i></button></div><p class="text-sm text-gray-400 bg-black/40 p-4 rounded-xl whitespace-pre-wrap">${d.memo || '-'}</p></div>`
            },
            notices: {
                collection: 'settings',
                fields: [{ id: 'content', label: '공지 내용', type: 'text' }],
                render: (id, d) => `<div class="card p-6 border-white/5 flex justify-between items-center"><div class="flex-grow pr-4"><p class="text-sm font-medium text-gray-200">${d.content}</p></div><div class="flex gap-2"><button onclick="openEdit('notices', '${id}', '${encodeURIComponent(JSON.stringify(d))}')" class="p-2 text-gray-500 hover:text-white"><i class="fas fa-edit"></i></button></div></div>`
            }
        };

        // 탭 전환
        window.switchTab = (tabId) => {
            currentTab = tabId;
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`nav-${tabId}`).classList.add('active');
            document.getElementById('add-btn').style.display = (tabId === 'inquiries') ? 'none' : 'flex';
        };

        // 모달 닫기
        window.closeModal = () => document.getElementById('crud-modal').classList.remove('active');

        // 등록/수정 필드 렌더링
        const renderFields = (tab, data = null) => {
            const fields = config[tab].fields || [];
            document.getElementById('form-fields').innerHTML = fields.map(f => {
                let inputHtml = f.type === 'select' ? 
                    `<select id="field-${f.id}" class="input-field">${f.options.map(o => `<option value="${o.value}" ${data && data[f.id] === o.value ? 'selected' : ''}>${o.label}</option>`).join('')}</select>` :
                    `<input type="${f.type}" id="field-${f.id}" class="input-field" value="${data ? data[f.id] || '' : ''}" required autocomplete="off">`;
                return `<div class="space-y-1"><label class="text-[10px] font-bold text-gray-500 uppercase ml-1">${f.label}</label>${inputHtml}</div>`;
            }).join('');
        };

        // 데이터 추가 버튼
        document.getElementById('add-btn').onclick = () => {
            document.getElementById('modal-title').innerText = "데이터 추가";
            document.getElementById('target-id').value = "";
            renderFields(currentTab);
            document.getElementById('crud-modal').classList.add('active');
        };

        // 수정 버튼 핸들러
        window.openEdit = (tab, id, encodedData) => {
            const data = JSON.parse(decodeURIComponent(encodedData));
            document.getElementById('modal-title').innerText = "데이터 수정";
            document.getElementById('target-id').value = id;
            renderFields(tab, data);
            document.getElementById('crud-modal').classList.add('active');
        };

        // 삭제 처리
        window.deleteItem = async (tab, id) => {
            if(!confirm('정말로 이 데이터를 삭제하시겠습니까?')) return;
            const collectionName = config[tab].collection;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, id));
            } catch (e) { console.error("Error deleting: ", e); }
        };

        // 폼 제출 (저장/수정)
        document.getElementById('crud-form').onsubmit = async (e) => {
            e.preventDefault();
            const targetId = document.getElementById('target-id').value;
            const collectionName = config[currentTab].collection;
            const fields = config[currentTab].fields || [];
            
            const payload = {};
            fields.forEach(f => {
                const el = document.getElementById(`field-${f.id}`);
                payload[f.id] = f.type === 'number' ? Number(el.value) : el.value;
            });
            payload.updatedAt = serverTimestamp();

            try {
                if (targetId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, targetId), payload);
                } else {
                    payload.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', collectionName), payload);
                }
                closeModal();
            } catch (e) { console.error("Error saving: ", e); }
        };

        // 로그인 로직
        const checkLogin = () => {
            const id = document.getElementById('auth-id').value;
            const pw = document.getElementById('auth-pw').value;
            if (id === "hanroro" && pw === "gksfhfh00@@") {
                localStorage.setItem('hanroro_session', 'authenticated');
                enterDashboard();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        const enterDashboard = async () => {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('main-sidebar').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            try {
                await signInAnonymously(auth);
            } catch (e) { console.error("Auth error: ", e); }
        };

        // 실시간 동기화
        const initSync = () => {
            const mappings = { projects: 'project-list', payments: 'payment-list', inquiries: 'inquiry-list', notices: 'notice-list' };
            Object.keys(config).forEach(tabKey => {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', config[tabKey].collection);
                onSnapshot(colRef, (snap) => {
                    const listEl = document.getElementById(mappings[tabKey]);
                    if (!listEl) return;
                    listEl.innerHTML = snap.docs.map(doc => config[tabKey].render(doc.id, doc.data())).join('');
                }, (err) => console.error(err));
            });
        };

        // 초기화
        document.getElementById('login-submit-btn').onclick = checkLogin;
        
        // 엔터키 로그인 지원
        document.getElementById('auth-pw').onkeypress = (e) => { if(e.key === 'Enter') checkLogin(); };

        document.getElementById('logout-btn').onclick = () => { 
            localStorage.removeItem('hanroro_session'); 
            location.reload(); 
        };

        onAuthStateChanged(auth, (user) => {
            if (user) initSync();
        });

        window.onload = () => {
            if (localStorage.getItem('hanroro_session') === 'authenticated') {
                enterDashboard();
            }
        };
    </script>
</body>
</html>
