<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="robots" content="noindex, nofollow">
    <title>Admin Console | HANRORO LIVE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@100..900&display=swap');
        :root { 
            --dash-dark: #05020a; 
            --dash-card: #0f0a1f; 
            --primary: #8a4fff; 
        }
        
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: var(--dash-dark); 
            color: #ececec; 
            margin: 0; 
            overscroll-behavior-y: none;
        }

        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }
        .glass-card { background: var(--dash-card); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1.25rem; }
        
        .input-field { 
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 0.75rem; 
            padding: 0.75rem; 
            width: 100%; 
            font-size: 14px; 
            color: white; 
            outline: none; 
        }

        .btn-primary { background: var(--primary); color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 700; font-size: 0.875rem; cursor: pointer; border: none; transition: opacity 0.2s; }
        .btn-primary:hover { opacity: 0.9; }
        
        .tab-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; color: #71717a; transition: all 0.2s; border: none; background: transparent; cursor: pointer; white-space: nowrap; }
        .tab-btn.active { background: rgba(138, 79, 255, 0.1); color: var(--primary); }

        #login-overlay { 
            position: fixed; inset: 0; z-index: 9999; background: var(--dash-dark); 
            display: flex; align-items: center; justify-content: center; padding: 1.5rem;
        }
        
        #admin-content { display: none; opacity: 0; transition: opacity 0.5s ease; }
        #admin-content.authorized { display: block; opacity: 1; }

        .modal { 
            display: none; position: fixed; inset: 0; z-index: 100; 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); 
            align-items: center; justify-content: center; padding: 1.5rem;
        }
        .modal.active { display: flex; }

        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 800; }
        .status-waiting { background: #f59e0b20; color: #f59e0b; }
        .status-complete { background: #10b98120; color: #10b981; }

        .quote-row:hover { background: rgba(138, 79, 255, 0.03); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-10 safe-pb">
    <!-- Login Layer -->
    <div id="login-overlay">
        <div class="glass-card w-full max-w-[360px] p-10 text-center border border-purple-500/20 shadow-2xl">
            <div class="mb-8">
                <i class="fas fa-shield-alt text-purple-500 text-3xl mb-4"></i>
                <h2 class="text-xl font-black text-white">ADMIN ACCESS</h2>
            </div>
            <div class="space-y-4">
                <input type="text" id="admin-id" class="input-field text-center" placeholder="ID">
                <input type="password" id="admin-pw" class="input-field text-center" placeholder="Password">
                <div id="login-error" class="text-red-500 text-[11px] font-bold hidden italic">ID 또는 비밀번호가 틀렸습니다.</div>
                <button id="login-btn" class="btn-primary w-full py-4 text-xs tracking-widest uppercase">Secure Login</button>
            </div>
        </div>
    </div>

    <!-- Main Admin Content -->
    <div id="admin-content">
        <header class="p-6 flex items-center justify-between border-b border-white/5 bg-black/40 sticky top-0 z-50 backdrop-blur-md safe-pt">
            <div>
                <h1 class="text-[10px] font-black text-purple-500 uppercase tracking-[0.2em]">Management Console v4.8</h1>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                    <span class="text-lg font-bold">Admin Dashboard</span>
                </div>
            </div>
            <button id="logout-btn" class="text-[10px] font-black text-gray-400 hover:text-white uppercase transition-colors">Logout</button>
        </header>

        <main class="p-4 md:p-8 max-w-7xl mx-auto space-y-8">
            <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar border-b border-white/5">
                <button onclick="switchTab('popup')" class="tab-btn active" id="tab-popup">팝업/공지</button>
                <button onclick="switchTab('quotes')" class="tab-btn" id="tab-quotes">견적 상담내역</button>
                <button onclick="switchTab('projects')" class="tab-btn" id="tab-projects">프로젝트</button>
                <button onclick="switchTab('finance')" class="tab-btn" id="tab-finance">입금현황</button>
                <button onclick="switchTab('cases')" class="tab-btn" id="tab-cases">성공사례</button>
            </div>

            <!-- 팝업 및 공지사항 관리 섹션 -->
            <section id="sec-popup" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="glass-card p-6">
                        <h3 class="text-xs font-black uppercase text-purple-400 mb-6 italic">Top Popup</h3>
                        <div class="space-y-4">
                            <input type="text" id="pop-top-title" class="input-field" placeholder="제목">
                            <textarea id="pop-top-content" class="input-field h-20" placeholder="내용"></textarea>
                            <button onclick="updateSettings('topPopup', 'top')" class="btn-primary w-full">상단 팝업 저장</button>
                        </div>
                    </div>
                    <div class="glass-card p-6">
                        <h3 class="text-xs font-black uppercase text-purple-400 mb-6 italic">Bottom Popup</h3>
                        <div class="space-y-4">
                            <input type="text" id="pop-btm-title" class="input-field" placeholder="제목">
                            <textarea id="pop-btm-content" class="input-field h-20" placeholder="내용"></textarea>
                            <button onclick="updateSettings('bottomPopup', 'btm')" class="btn-primary w-full">하단 팝업 저장</button>
                        </div>
                    </div>
                </div>

                <!-- 공지사항 리스트 섹션 -->
                <div class="glass-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xs font-black uppercase text-purple-400 italic">Notice Management</h3>
                        <button onclick="openModal('notice-modal')" class="text-[10px] font-bold bg-white/5 px-3 py-1 rounded-lg hover:bg-white/10">+ 공지 추가</button>
                    </div>
                    <div id="admin-notice-list" class="space-y-2">
                        <!-- 공지사항 렌더링 영역 -->
                    </div>
                </div>
            </section>

            <!-- 견적 상담내역 섹션 -->
            <section id="sec-quotes" class="hidden space-y-6">
                <div class="glass-card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-white/5 text-[10px] uppercase text-gray-500 font-black">
                                <tr>
                                    <th class="p-5">날짜</th>
                                    <th class="p-5">고객/업체명</th>
                                    <th class="p-5">연락처</th>
                                    <th class="p-5">유형</th>
                                    <th class="p-5 text-right">상세</th>
                                </tr>
                            </thead>
                            <tbody id="admin-quote-list" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 프로젝트 관리 섹션 -->
            <section id="sec-projects" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Project Tracker</h3>
                    <button onclick="openModal('project-modal')" class="bg-purple-600 px-4 py-2 rounded-lg text-xs font-bold">+ 프로젝트 추가</button>
                </div>
                <div id="admin-project-list" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </section>

            <!-- 입금 현황 섹션 -->
            <section id="sec-finance" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Finance Status</h3>
                    <button onclick="openModal('deposit-modal')" class="bg-purple-600 px-4 py-2 rounded-lg text-xs font-bold">+ 현황 추가</button>
                </div>
                <div class="glass-card overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <tbody id="admin-deposit-list" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </section>

            <!-- 성공 사례 섹션 -->
            <section id="sec-cases" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Success Cases</h3>
                    <button onclick="openModal('case-modal')" class="bg-purple-600 px-4 py-2 rounded-lg text-xs font-bold">+ 사례 추가</button>
                </div>
                <div id="admin-case-list" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </section>
        </main>
    </div>

    <!-- 모달: 공지사항 편집 -->
    <div id="notice-modal" class="modal">
        <div class="glass-card w-full max-w-md p-8 mx-4">
            <h3 class="text-lg font-black mb-4">공지사항 편집</h3>
            <div class="space-y-3">
                <input type="hidden" id="modal-notice-id">
                <input type="text" id="modal-notice-title" class="input-field" placeholder="공지 제목">
                <textarea id="modal-notice-content" class="input-field h-32" placeholder="공지 내용"></textarea>
                <div class="flex gap-2 mt-4">
                    <button onclick="closeModal('notice-modal')" class="flex-1 bg-white/5 py-3 rounded-xl">취소</button>
                    <button onclick="saveItem('notices')" class="flex-1 btn-primary py-3 rounded-xl">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달: 견적 상세보기 -->
    <div id="quote-detail-modal" class="modal">
        <div class="glass-card w-full max-w-lg p-8 mx-4">
            <h3 class="text-xl font-black mb-1 text-white uppercase">상세 견적 정보</h3>
            <p class="text-[10px] text-purple-400 mb-8 font-bold tracking-widest italic">Project Request Details</p>
            <div id="quote-detail-content" class="space-y-4 text-sm text-gray-300"></div>
            <div class="flex gap-2 mt-8">
                <button onclick="closeModal('quote-detail-modal')" class="flex-1 bg-white/5 py-4 rounded-xl text-xs font-bold">닫기</button>
                <button id="delete-quote-btn" class="flex-1 bg-red-900/20 text-red-500 py-4 rounded-xl text-xs font-bold border border-red-900/30">내역 삭제</button>
            </div>
        </div>
    </div>

    <!-- 모달: 프로젝트/입금/성공사례 편집 -->
    <div id="project-modal" class="modal"><div class="glass-card w-full max-w-md p-8 mx-4"><h3 class="text-lg font-black mb-4">프로젝트 편집</h3><div class="space-y-3"><input type="hidden" id="modal-project-id"><input type="text" id="modal-project-name" class="input-field" placeholder="프로젝트명"><input type="number" id="modal-project-progress" class="input-field" placeholder="진행률 %"><input type="text" id="modal-project-phase" class="input-field" placeholder="현재 단계"><div class="flex gap-2 mt-4"><button onclick="closeModal('project-modal')" class="flex-1 bg-white/5 py-3 rounded-xl">취소</button><button onclick="saveItem('projects')" class="flex-1 btn-primary py-3 rounded-xl">저장</button></div></div></div></div>
    <div id="deposit-modal" class="modal"><div class="glass-card w-full max-w-md p-8 mx-4"><h3 class="text-lg font-black mb-4">입금현황 편집</h3><div class="space-y-3"><input type="hidden" id="modal-deposit-id"><input type="text" id="modal-deposit-name" class="input-field" placeholder="고객명"><input type="text" id="modal-deposit-amount" class="input-field" placeholder="금액"><select id="modal-deposit-status" class="input-field bg-black"><option value="waiting">입금 대기</option><option value="complete">입금 완료</option></select><div class="flex gap-2 mt-4"><button onclick="closeModal('deposit-modal')" class="flex-1 bg-white/5 py-3 rounded-xl">취소</button><button onclick="saveItem('deposits')" class="flex-1 btn-primary py-3 rounded-xl">저장</button></div></div></div></div>
    <div id="case-modal" class="modal"><div class="glass-card w-full max-w-xl p-8 mx-4 overflow-y-auto max-h-[90vh]"><h3 class="text-lg font-black mb-4">성공 사례 편집</h3><div class="space-y-3"><input type="hidden" id="modal-case-id"><input type="text" id="modal-case-title" class="input-field" placeholder="제목"><input type="text" id="modal-case-category" class="input-field" placeholder="카테고리"><input type="text" id="modal-case-img" class="input-field" placeholder="이미지 URL"><textarea id="modal-case-summary" class="input-field h-20" placeholder="요약"></textarea><textarea id="modal-case-detail" class="input-field h-32" placeholder="상세 내용"></textarea><div class="flex gap-2 mt-4"><button onclick="closeModal('case-modal')" class="flex-1 bg-white/5 py-3 rounded-xl">취소</button><button onclick="saveItem('cases')" class="flex-1 btn-primary py-3 rounded-xl">저장</button></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, addDoc, deleteDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const ADMIN_ID = 'hanroro';
        const ADMIN_PW = 'gksfhfh00@@';
        const AUTH_KEY = 'hanroro_secure_session_v5';

        const firebaseConfig = {
          apiKey: "AIzaSyBkWgHnnHTKaOfHmgt7P-OwptraKcwEXvI",
          authDomain: "hanroro-web.firebaseapp.com",
          projectId: "hanroro-web",
          appId: "1:461514865624:web:4ab6ad23c2e771b426d0ad"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "hanroro-official-service";

        // 로그인 로직
        window.handleLogin = () => {
            const id = document.getElementById('admin-id').value;
            const pw = document.getElementById('admin-pw').value;
            if (id === ADMIN_ID && pw === ADMIN_PW) {
                sessionStorage.setItem(AUTH_KEY, 'TRUE');
                showDashboard();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        window.logout = () => { sessionStorage.removeItem(AUTH_KEY); location.reload(); };

        const showDashboard = async () => {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            setTimeout(() => { document.getElementById('admin-content').classList.add('authorized'); }, 50);
            try { await signInAnonymously(auth); initData(); } catch (error) { console.error("Auth Error:", error); }
        };

        // 데이터 초기화
        function initData() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    syncData('projects', 'admin-project-list', renderProject);
                    syncData('deposits', 'admin-deposit-list', renderDeposit);
                    syncData('cases', 'admin-case-list', renderCase);
                    syncData('quotes', 'admin-quote-list', renderQuote);
                    syncData('notices', 'admin-notice-list', renderNotice);
                    loadSettings();
                }
            });
        }

        // 실시간 동기화 함수
        function syncData(col, containerId, renderFn) {
            const q = collection(db, 'artifacts', appId, 'public', 'data', col);
            onSnapshot(q, (snap) => {
                const el = document.getElementById(containerId);
                if (!el) return;
                let docs = [];
                snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
                
                docs.sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
                
                if (docs.length === 0) {
                    el.innerHTML = containerId.includes('list') && !containerId.includes('project') && !containerId.includes('notice') ? '<tr><td colspan="5" class="p-10 text-center text-gray-600">내역이 없습니다.</td></tr>' : '<p class="p-4 text-center text-gray-600 text-xs">데이터가 없습니다.</p>';
                } else {
                    el.innerHTML = "";
                    docs.forEach(data => {
                        const item = renderFn(data.id, data);
                        if(item instanceof Node) el.appendChild(item);
                        else el.insertAdjacentHTML('beforeend', item);
                    });
                }
            });
        }

        // 렌더링: 공지사항
        function renderNotice(id, n) {
            const d = document.createElement('div');
            d.className = "flex items-center justify-between p-4 bg-white/5 rounded-xl border border-white/5 hover:border-purple-500/20 transition-all group";
            d.innerHTML = `
                <div>
                    <h4 class="text-sm font-bold text-white">${n.title || '-'}</h4>
                    <p class="text-[10px] text-gray-500 mt-1 truncate max-w-[200px]">${n.content || '-'}</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="editNotice('${id}', \`${encodeURIComponent(JSON.stringify(n))}\`)"><i class="fas fa-edit text-gray-500 hover:text-purple-400 transition-colors"></i></button>
                    <button onclick="deleteItem('notices', '${id}')"><i class="fas fa-trash text-red-900/40 hover:text-red-500 transition-colors"></i></button>
                </div>
            `;
            return d;
        }

        // 렌더링: 견적
        function renderQuote(id, q) {
            const tr = document.createElement('tr'); 
            tr.className = "quote-row transition-colors cursor-pointer group";
            const dateStr = q.updatedAt ? new Date(q.updatedAt.seconds * 1000).toLocaleDateString() : '-';
            tr.innerHTML = `
                <td class="p-5 text-[11px] text-gray-500 font-mono">${dateStr}</td>
                <td class="p-5 text-xs font-bold text-white">${q.name || '-'}</td>
                <td class="p-5 text-xs text-gray-400">${q.phone || '-'}</td>
                <td class="p-5 text-[10px] text-purple-400 font-black uppercase">${Array.isArray(q.types) ? q.types.join(', ') : (q.type || '-')}</td>
                <td class="p-5 text-right"><i class="fas fa-search text-gray-600 group-hover:text-purple-400"></i></td>
            `;
            tr.onclick = () => viewQuoteDetail(id, q);
            return tr;
        }

        // 렌더링: 프로젝트
        function renderProject(id, p) {
            const d = document.createElement('div');
            d.className = "glass-card p-4 flex justify-between items-center";
            d.innerHTML = `
                <div>
                    <h4 class="font-bold text-sm">${p.name || '-'}</h4>
                    <p class="text-[10px] text-purple-400 uppercase font-bold">${p.phase || '-'} (${p.progress || 0}%)</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="editProject('${id}', \`${encodeURIComponent(JSON.stringify(p))}\`)"><i class="fas fa-edit text-gray-500"></i></button>
                    <button onclick="deleteItem('projects', '${id}')"><i class="fas fa-trash text-red-900/40"></i></button>
                </div>
            `;
            return d;
        }

        // 렌더링: 입금
        function renderDeposit(id, d) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="p-5 text-xs text-white">${d.name || '-'}</td>
                <td class="p-5 text-xs text-purple-400 font-bold">${d.amount || '-'}</td>
                <td class="p-5"><span class="status-badge ${d.status === 'complete' ? 'status-complete' : 'status-waiting'}">${d.status === 'complete' ? 'COMPLETE' : 'WAITING'}</span></td>
                <td class="p-5 text-right">
                    <button onclick="editDeposit('${id}', \`${encodeURIComponent(JSON.stringify(d))}\`)" class="mr-3"><i class="fas fa-edit text-gray-500"></i></button>
                    <button onclick="deleteItem('deposits', '${id}')"><i class="fas fa-trash text-red-900/40"></i></button>
                </td>
            `;
            return tr;
        }

        // 렌더링: 성공사례
        function renderCase(id, c) {
            const d = document.createElement('div');
            d.className = "glass-card overflow-hidden";
            d.innerHTML = `
                <div class="h-24 bg-black/40"><img src="${c.image || ''}" class="w-full h-full object-cover opacity-50"></div>
                <div class="p-4 flex justify-between items-center">
                    <h4 class="text-xs font-bold truncate pr-4">${c.title || '-'}</h4>
                    <div class="flex gap-2">
                        <button onclick="editCase('${id}', \`${encodeURIComponent(JSON.stringify(c))}\`)"><i class="fas fa-edit text-gray-500"></i></button>
                        <button onclick="deleteItem('cases', '${id}')"><i class="fas fa-trash text-red-900/40"></i></button>
                    </div>
                </div>
            `;
            return d;
        }

        // 데이터 저장
        window.saveItem = async (col) => {
            const type = col === 'projects' ? 'project' : col === 'deposits' ? 'deposit' : col === 'notices' ? 'notice' : 'case';
            const id = document.getElementById(`modal-${type}-id`).value;
            let data = { updatedAt: serverTimestamp() };

            if(col === 'projects') {
                data.name = document.getElementById('modal-project-name').value;
                data.progress = parseInt(document.getElementById('modal-project-progress').value) || 0;
                data.phase = document.getElementById('modal-project-phase').value;
            } else if(col === 'deposits') {
                data.name = document.getElementById('modal-deposit-name').value;
                data.amount = document.getElementById('modal-deposit-amount').value;
                data.status = document.getElementById('modal-deposit-status').value;
            } else if(col === 'notices') {
                data.title = document.getElementById('modal-notice-title').value;
                data.content = document.getElementById('modal-notice-content').value;
            } else if(col === 'cases') {
                data.title = document.getElementById('modal-case-title').value;
                data.category = document.getElementById('modal-case-category').value;
                data.image = document.getElementById('modal-case-img').value;
                data.summary = document.getElementById('modal-case-summary').value;
                data.detail = document.getElementById('modal-case-detail').value;
            }

            try {
                if(id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id), data);
                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', col), data);
                closeModal(`${type}-modal`);
            } catch (e) { alert('저장 실패: ' + e.message); }
        };

        window.deleteItem = async (col, id, modalToClose = null) => {
            if(confirm('정말로 삭제하시겠습니까?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
                if(modalToClose) closeModal(modalToClose);
            }
        };

        // 견적 상세보기 모달
        window.viewQuoteDetail = (id, q) => {
            const content = document.getElementById('quote-detail-content');
            const dateStr = q.updatedAt ? new Date(q.updatedAt.seconds * 1000).toLocaleString() : '-';
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white/5 p-3 rounded-lg"><p class="text-[9px] text-gray-500 uppercase">Name</p><p class="text-white font-bold">${q.name || '-'}</p></div>
                        <div class="bg-white/5 p-3 rounded-lg"><p class="text-[9px] text-gray-500 uppercase">Phone</p><p class="text-white font-bold">${q.phone || '-'}</p></div>
                    </div>
                    <div class="bg-white/5 p-3 rounded-lg"><p class="text-[9px] text-gray-500 uppercase">Project Types</p><p class="text-purple-400 font-bold">${Array.isArray(q.types) ? q.types.join(' / ') : (q.type || '-')}</p></div>
                    <div class="bg-white/5 p-3 rounded-lg"><p class="text-[9px] text-gray-500 uppercase">Memo</p><p class="text-gray-300 leading-relaxed">${q.memo || '내용 없음'}</p></div>
                    <div class="text-right text-[10px] text-gray-600 font-mono">Date: ${dateStr}</div>
                </div>
            `;
            document.getElementById('delete-quote-btn').onclick = () => deleteItem('quotes', id, 'quote-detail-modal');
            openModal('quote-detail-modal');
        };

        // 설정 로드/업데이트
        async function loadSettings() {
            ['topPopup', 'bottomPopup'].forEach(async (sid) => {
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', sid));
                if(snap.exists()) {
                    const d = snap.data();
                    const pre = sid === 'topPopup' ? 'top' : 'btm';
                    document.getElementById(`pop-${pre}-title`).value = d.title || '';
                    document.getElementById(`pop-${pre}-content`).value = d.content || '';
                }
            });
        }

        window.updateSettings = async (docId, prefix) => {
            const data = {
                title: document.getElementById(`pop-${prefix}-title`).value,
                content: document.getElementById(`pop-${prefix}-content`).value,
                updatedAt: serverTimestamp()
            };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', docId), data);
            alert('저장되었습니다.');
        };

        // 유틸리티
        window.switchTab = (t) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`sec-${t}`).classList.remove('hidden');
            document.getElementById(`tab-${t}`).classList.add('active');
        };
        window.openModal = (id) => { document.getElementById(id).classList.add('active'); };
        window.closeModal = (id) => { 
            document.getElementById(id).classList.remove('active'); 
            // 모달 닫을 때 ID 초기화
            const hid = document.querySelector(`#${id} input[type="hidden"]`);
            if(hid) hid.value = "";
            const inputs = document.querySelectorAll(`#${id} input:not([type="hidden"]), #${id} textarea`);
            inputs.forEach(i => i.value = "");
        };

        // 수정 핸들러
        window.editProject = (id, enc) => { const p = JSON.parse(decodeURIComponent(enc)); openModal('project-modal'); document.getElementById('modal-project-id').value = id; document.getElementById('modal-project-name').value = p.name; document.getElementById('modal-project-progress').value = p.progress; document.getElementById('modal-project-phase').value = p.phase; };
        window.editDeposit = (id, enc) => { const d = JSON.parse(decodeURIComponent(enc)); openModal('deposit-modal'); document.getElementById('modal-deposit-id').value = id; document.getElementById('modal-deposit-name').value = d.name; document.getElementById('modal-deposit-amount').value = d.amount; document.getElementById('modal-deposit-status').value = d.status; };
        window.editCase = (id, enc) => { const c = JSON.parse(decodeURIComponent(enc)); openModal('case-modal'); document.getElementById('modal-case-id').value = id; document.getElementById('modal-case-title').value = c.title; document.getElementById('modal-case-category').value = c.category; document.getElementById('modal-case-img').value = c.image; document.getElementById('modal-case-summary').value = c.summary; document.getElementById('modal-case-detail').value = c.detail; };
        window.editNotice = (id, enc) => { const n = JSON.parse(decodeURIComponent(enc)); openModal('notice-modal'); document.getElementById('modal-notice-id').value = id; document.getElementById('modal-notice-title').value = n.title; document.getElementById('modal-notice-content').value = n.content; };

        document.getElementById('login-btn').addEventListener('click', window.handleLogin);
        document.getElementById('logout-btn').addEventListener('click', window.logout);
        if (sessionStorage.getItem(AUTH_KEY) === 'TRUE') showDashboard();
    </script>
</body>
</html>
