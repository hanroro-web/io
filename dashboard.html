<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한로로 제어 센터 | 관리자</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // 1. 제공해주신 실제 파이어베이스 설정값 적용
        const firebaseConfig = {
            apiKey: "AIzaSyBkWgHnnHTKaOfHmgt7P-OwptraKcwEXvI",
            authDomain: "hanroro-web.firebaseapp.com",
            projectId: "hanroro-web",
            storageBucket: "hanroro-web.firebasestorage.app",
            messagingSenderId: "461514865624",
            appId: "1:461514865624:web:4ab6ad23c2e771b426d0ad",
            measurementId: "G-8L3EFM6PY8"
        };

        let db, auth;
        const appId = 'hanroro-web';
        let isAuthReady = false;
        let editingId = null;

        const initSystem = async () => {
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');

            try {
                // 초기화
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 익명 로그인 시도 (Authentication에서 익명 활성화 필수)
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        statusText.innerText = "데이터베이스 연결됨";
                        statusDot.className = "w-2 h-2 rounded-full bg-emerald-500 mr-2";
                        setupRealtimeListener();
                    }
                });

            } catch (err) {
                console.error("연결 실패:", err);
                statusText.innerText = "연결 오류";
                statusDot.className = "w-2 h-2 rounded-full bg-red-500 mr-2";
                alert("네트워크 또는 설정 오류: " + err.message);
            }
        };

        // 실시간 데이터 감시
        function setupRealtimeListener() {
            const noticeCol = collection(db, 'artifacts', appId, 'public', 'data', 'notices');
            onSnapshot(noticeCol, (snapshot) => {
                const listElement = document.getElementById('notice-list');
                let notices = [];
                snapshot.forEach(doc => notices.push({ id: doc.id, ...doc.data() }));
                
                // 최신순 정렬
                notices.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                let html = '';
                notices.forEach(notice => {
                    const date = notice.createdAt ? new Date(notice.createdAt.seconds * 1000).toLocaleString('ko-KR') : '방금 전';
                    html += `
                        <div class="glass-item p-5 rounded-2xl mb-4 border border-white/5 hover:border-purple-500/30 transition-all">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-white text-[15px] leading-relaxed break-all">${notice.text}</p>
                                    <p class="text-[10px] text-gray-500 mt-2 font-mono">${date}</p>
                                </div>
                                <div class="flex space-x-2 ml-4">
                                    <button onclick="prepareEdit('${notice.id}', \`${notice.text.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" 
                                            class="w-8 h-8 rounded-lg bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-white transition-all flex items-center justify-center">
                                        <i class="fas fa-edit text-[10px]"></i>
                                    </button>
                                    <button onclick="deleteNotice('${notice.id}')" 
                                            class="w-8 h-8 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition-all flex items-center justify-center">
                                        <i class="fas fa-trash-alt text-[10px]"></i>
                                    </button>
                                </div>
                            </div>
                        </div>`;
                });
                listElement.innerHTML = html || `<div class="py-20 text-center opacity-20 text-xs italic">데이터가 없습니다.</div>`;
            }, (err) => {
                console.error("Firestore error:", err);
                alert("데이터 로드 실패: Firestore 보안 규칙을 확인하세요.");
            });
        }

        // 저장 및 수정
        window.saveNotice = async () => {
            if (!isAuthReady) return;
            const input = document.getElementById('notice-input');
            const text = input.value.trim();
            if (!text) return;

            const btn = document.getElementById('submit-btn');
            try {
                btn.disabled = true;
                btn.innerText = "처리 중...";

                if (editingId) {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'notices', editingId);
                    await updateDoc(docRef, { text, updatedAt: serverTimestamp() });
                    editingId = null;
                } else {
                    const noticeCol = collection(db, 'artifacts', appId, 'public', 'data', 'notices');
                    await addDoc(noticeCol, { 
                        text, 
                        createdAt: serverTimestamp() 
                    });
                }
                input.value = "";
                updateUI();
            } catch (e) {
                alert("저장 실패: 파이어베이스 규칙을 확인하세요.");
            } finally {
                btn.disabled = false;
            }
        };

        window.deleteNotice = async (id) => {
            if (confirm("정말 삭제하시겠습니까?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notices', id));
            }
        };

        window.prepareEdit = (id, text) => {
            editingId = id;
            document.getElementById('notice-input').value = text;
            updateUI();
        };

        window.cancelEdit = () => {
            editingId = null;
            document.getElementById('notice-input').value = "";
            updateUI();
        };

        function updateUI() {
            const btn = document.getElementById('submit-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            btn.innerText = editingId ? "내용 수정하기" : "공지 등록 및 배포";
            btn.className = editingId 
                ? "w-full mt-4 bg-blue-600 py-4 rounded-xl font-bold text-sm" 
                : "w-full mt-4 bg-purple-600 py-4 rounded-xl font-bold text-sm";
            editingId ? cancelBtn.classList.remove('hidden') : cancelBtn.classList.add('hidden');
        }

        window.onload = initSystem;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background: #080410; color: white; -webkit-font-smoothing: antialiased; }
        .glass-panel { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .glass-item { background: rgba(255, 255, 255, 0.03); }
    </style>
</head>
<body class="p-6 md:p-12 min-h-screen flex items-center justify-center">
    <div class="max-w-xl w-full">
        <header class="flex justify-between items-center mb-10">
            <h1 class="text-xl font-black tracking-tighter uppercase italic text-purple-500">Hanroro Admin</h1>
            <div class="glass-panel px-4 py-2 rounded-xl flex items-center text-[10px] font-bold">
                <span id="status-dot" class="w-2 h-2 rounded-full bg-yellow-500 mr-2 animate-pulse"></span>
                <span id="status-text" class="text-gray-400">연결 대기</span>
            </div>
        </header>

        <div class="glass-panel rounded-[2.5rem] p-8 mb-8 shadow-2xl">
            <div class="flex justify-between mb-4">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Editor</span>
                <button id="cancel-btn" onclick="cancelEdit()" class="hidden text-xs text-red-400 font-bold hover:underline">취소</button>
            </div>
            <textarea id="notice-input" rows="4" class="w-full bg-white/5 border border-white/10 rounded-2xl p-5 text-sm outline-none focus:border-purple-600 transition-all resize-none placeholder:text-gray-700" placeholder="공지 내용을 입력하세요..."></textarea>
            <button id="submit-btn" onclick="saveNotice()" class="w-full mt-4 bg-purple-600 hover:bg-purple-700 py-4 rounded-xl font-bold text-sm transition-all active:scale-[0.98] shadow-lg shadow-purple-900/20">공지 등록 및 배포</button>
        </div>

        <div class="glass-panel rounded-[2.5rem] p-8 min-h-[350px]">
            <h2 class="text-xs font-bold text-gray-500 mb-6 uppercase tracking-widest text-center">Live History</h2>
            <div id="notice-list"></div>
        </div>
    </div>
</body>
</html>
