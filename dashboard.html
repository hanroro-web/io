<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@100..900&display=swap');
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: #05020a; 
            color: #ffffff; 
            margin: 0; 
            overflow: hidden; 
            /* 텍스트 선택 방지 추가 */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .glass-panel { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); }
        #auth-guard { position: fixed; inset: 0; background: #05020a; z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        #admin-layout { display: none; opacity: 0; transition: opacity 0.5s ease; height: 100vh; }
        #admin-layout.active { display: flex; opacity: 1; }
        .sidebar-link { transition: all 0.3s ease; border-left: 3px solid transparent; color: #666; cursor: pointer; }
        .sidebar-link.active { background: rgba(138, 79, 255, 0.15); color: #a78bfa; border-left: 3px solid #8a4fff; }
        .custom-input { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 12px 16px; color: white; width: 100%; outline: none; font-size: 14px; transition: border 0.3s; }
        .custom-input:focus { border-color: #8a4fff; }
        .btn-primary { background: #8a4fff; color: white; padding: 14px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; border: none; transition: transform 0.2s; }
        .btn-primary:active { transform: scale(0.98); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        #toast { position: fixed; bottom: 30px; right: 30px; padding: 16px 24px; border-radius: 12px; background: #8a4fff; color: white; font-weight: bold; transform: translateY(100px); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 10000; }
        #toast.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body oncontextmenu="return false" onselectstart="return false" ondragstart="return false">

    <div id="toast">알림 메시지</div>

    <!-- Auth Guard -->
    <div id="auth-guard">
        <div class="w-full max-w-sm p-10 glass-panel rounded-[32px] text-center">
            <div class="text-4xl font-black text-purple-500 tracking-tighter uppercase mb-2">HANRORO</div>
            <p class="text-gray-500 text-xs tracking-widest uppercase mb-10">Admin Security</p>
            <input type="password" id="admin-passcode" class="custom-input mb-4 text-center" placeholder="Passcode">
            <button onclick="attemptLogin()" class="btn-primary w-full">Unlock Dashboard</button>
        </div>
    </div>

    <div id="admin-layout">
        <!-- Sidebar Navigation -->
        <aside class="w-72 border-r border-white/5 flex flex-col h-full bg-[#05020a]">
            <div class="p-10 text-2xl font-black text-purple-500 uppercase tracking-tighter">HANRORO</div>
            <nav class="flex-1 px-6 space-y-2">
                <button onclick="showTab('quotes-tab')" class="sidebar-link w-full text-left px-5 py-4 rounded-xl text-sm font-bold flex items-center gap-4 active" id="btn-quotes-tab">
                    <i class="fas fa-comment-dots w-5"></i> 상담 내역 확인
                </button>
                <button onclick="showTab('projects-tab')" class="sidebar-link w-full text-left px-5 py-4 rounded-xl text-sm font-bold flex items-center gap-4" id="btn-projects-tab">
                    <i class="fas fa-tasks w-5"></i> 프로젝트 관리
                </button>
                <button onclick="showTab('deposits-tab')" class="sidebar-link w-full text-left px-5 py-4 rounded-xl text-sm font-bold flex items-center gap-4" id="btn-deposits-tab">
                    <i class="fas fa-wallet w-5"></i> 입금 현황 관리
                </button>
                <button onclick="showTab('popups-tab')" class="sidebar-link w-full text-left px-5 py-4 rounded-xl text-sm font-bold flex items-center gap-4" id="btn-popups-tab">
                    <i class="fas fa-bullhorn w-5"></i> 공지사항 관리
                </button>
                <button onclick="showTab('settings-tab')" class="sidebar-link w-full text-left px-5 py-4 rounded-xl text-sm font-bold flex items-center gap-4" id="btn-settings-tab">
                    <i class="fas fa-cog w-5"></i> 시스템 설정
                </button>
            </nav>
            <div class="p-8">
                <button onclick="location.reload()" class="w-full py-4 rounded-xl bg-white/5 text-gray-500 text-xs font-bold border border-white/5">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-12 overflow-y-auto bg-[#080510]">
            
            <!-- 1. 상담 내역 확인 -->
            <section id="quotes-tab" class="tab-content active">
                <div class="mb-10 flex justify-between items-end">
                    <div>
                        <h2 class="text-4xl font-black mb-3 text-white">상담 신청 내역</h2>
                        <p class="text-gray-500 text-sm">신규 신청 시 템플릿(template_7meyimh) 규격으로 메일이 발송됩니다.</p>
                    </div>
                </div>
                <div class="glass-panel rounded-3xl overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-white/5 text-gray-400 uppercase text-[11px] tracking-widest">
                            <tr>
                                <th class="p-5">신청자/연락처</th>
                                <th class="p-5">카테고리</th>
                                <th class="p-5">상담 내용</th>
                                <th class="p-5">접수 일시</th>
                                <th class="p-5 text-right">관리</th>
                            </tr>
                        </thead>
                        <tbody id="quote-table-body">
                            <tr><td colspan="5" class="p-20 text-center text-gray-500 text-sm">데이터를 불러오는 중입니다...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 2. 프로젝트 현황 관리 -->
            <section id="projects-tab" class="tab-content">
                <div class="mb-10 flex justify-between items-center">
                    <h2 class="text-4xl font-black text-white">프로젝트 현황</h2>
                    <button onclick="addProject()" class="btn-primary !py-3 !px-6 text-sm">+ 새 프로젝트 추가</button>
                </div>
                <div class="grid grid-cols-1 gap-4" id="admin-project-list">
                    <!-- Projects -->
                </div>
            </section>

            <!-- 3. 입금 현황 관리 -->
            <section id="deposits-tab" class="tab-content">
                <div class="mb-10"><h2 class="text-4xl font-black text-white">실시간 입금 관리</h2></div>
                <div class="glass-panel rounded-3xl overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-white/5 text-gray-400 uppercase text-[11px] tracking-widest">
                            <tr>
                                <th class="p-5">입금자명</th>
                                <th class="p-5">신청 서비스</th>
                                <th class="p-5">상태</th>
                                <th class="p-5">신청일</th>
                                <th class="p-5 text-right">관리</th>
                            </tr>
                        </thead>
                        <tbody id="deposit-table-body">
                            <!-- Deposits -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 4. 공지 및 알림 관리 -->
            <section id="popups-tab" class="tab-content">
                <div class="mb-10"><h2 class="text-4xl font-black text-white">공지 및 배너 관리</h2></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="glass-panel p-8 rounded-[32px] border border-purple-500/20">
                        <h3 class="text-xl font-bold mb-6 text-purple-400">하단 띠배너(Notice) 문구</h3>
                        <div class="space-y-4">
                            <label class="text-[10px] text-gray-500 uppercase font-black">메인 페이지 노출 텍스트</label>
                            <input type="text" id="main-notice-text" class="custom-input" placeholder="이곳에 공지사항을 입력하세요">
                            <button onclick="saveMainSettings()" class="btn-primary w-full mt-4">메인 공지 즉시 적용</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 5. 시스템 설정 -->
            <section id="settings-tab" class="tab-content">
                <div class="mb-10"><h2 class="text-4xl font-black text-white">시스템 설정</h2></div>
                <div class="glass-panel p-8 rounded-[32px] max-w-2xl">
                    <div class="space-y-6">
                        <div>
                            <label class="text-[11px] text-gray-500 uppercase font-bold mb-2 block">알림 수신 이메일</label>
                            <input type="email" id="admin-email" class="custom-input" value="hanroro.web@gmail.com">
                        </div>
                        <div class="pt-6 border-t border-white/5 space-y-2">
                            <p class="text-[11px] text-gray-500">Public Key: <span class="text-white">QvGeQgdI2NrDe_TG9</span></p>
                            <p class="text-[11px] text-gray-500">Template ID: <span class="text-purple-400 font-bold">template_7meyimh</span></p>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- 우클릭 및 보안 스크립트 -->
    <script>
        document.addEventListener('keydown', function(e) {
            // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U, Ctrl+S 방지
            if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || (e.ctrlKey && e.keyCode === 85) || (e.ctrlKey && e.keyCode === 83)) {
                e.preventDefault();
                return false;
            }
        });
        // 우클릭 방지는 body 태그 속성(oncontextmenu)으로도 적용되어 있습니다.
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, deleteDoc, query, orderBy, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBkWgHnnHTKaOfHmgt7P-OwptraKcwEXvI", 
            authDomain: "hanroro-web.firebaseapp.app", 
            projectId: "hanroro-web" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const currentAppId = "hanroro-official-service";

        // EmailJS Config (New Key & Template Applied)
        const EMAIL_SERVICE_ID = "service_kobfkfj";
        const EMAIL_TEMPLATE_ID = "template_7meyimh";
        const EMAIL_PUBLIC_KEY = "QvGeQgdI2NrDe_TG9"; 
        emailjs.init(EMAIL_PUBLIC_KEY);

        window.showToast = (msg) => {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        window.attemptLogin = async () => {
            const pass = document.getElementById('admin-passcode').value;
            if (pass === "gksfhfh00@@") {
                await signInAnonymously(auth);
                document.getElementById('auth-guard').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('auth-guard').style.display = 'none';
                    document.getElementById('admin-layout').classList.add('active');
                    startDataMonitoring();
                }, 500);
            } else {
                showToast('패스코드가 올바르지 않습니다.');
            }
        };

        let lastQuoteId = null;

        function startDataMonitoring() {
            // 1. Quotes
            const qQuotes = query(collection(db, 'artifacts', currentAppId, 'public', 'data', 'quotes'), orderBy('createdAt', 'desc'));
            onSnapshot(qQuotes, (snap) => {
                let html = '';
                snap.docChanges().forEach(change => {
                    if (change.type === "added" && lastQuoteId !== null) {
                        sendNotificationEmail(change.doc.data());
                    }
                });
                snap.forEach((d, idx) => {
                    if (idx === 0) lastQuoteId = d.id;
                    const data = d.data();
                    const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : '-';
                    html += `
                        <tr class="border-b border-white/5 hover:bg-white/5 transition-all">
                            <td class="p-5 font-bold text-gray-100">${data.name}<br><span class="text-[10px] text-gray-500 font-normal">${data.contact}</span></td>
                            <td class="p-5"><span class="text-[10px] bg-purple-500/10 text-purple-400 px-2 py-1 rounded font-black uppercase">${data.category || 'GENERAL'}</span></td>
                            <td class="p-5"><p class="text-xs text-gray-400 truncate max-w-xs">${data.content}</p></td>
                            <td class="p-5 text-[11px] text-gray-600">${date}</td>
                            <td class="p-5 text-right flex justify-end gap-3">
                                <button onclick="window.resendQuote('${d.id}')" title="메일 재전송" class="text-gray-600 hover:text-purple-400 transition-colors"><i class="fas fa-paper-plane"></i></button>
                                <button onclick="window.delData('quotes', '${d.id}')" title="내역 삭제" class="text-gray-600 hover:text-red-500 transition-colors"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('quote-table-body').innerHTML = html || '<tr><td colspan="5" class="p-20 text-center text-gray-500 font-bold">신청 내역이 존재하지 않습니다.</td></tr>';
            });

            // 2. Projects
            onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'projects'), (snap) => {
                let html = '';
                snap.forEach(d => {
                    const p = d.data();
                    html += `
                        <div class="glass-panel p-6 rounded-2xl border border-white/5 mb-4">
                            <div class="flex flex-wrap items-center gap-6">
                                <div class="flex-1 min-w-[200px]">
                                    <label class="text-[10px] text-gray-500 uppercase font-black mb-1 block">프로젝트명</label>
                                    <input type="text" class="custom-input !py-2" value="${p.name}" onchange="window.updateProject('${d.id}', 'name', this.value)">
                                </div>
                                <div class="w-24">
                                    <label class="text-[10px] text-gray-500 uppercase font-black mb-1 block">진행률(%)</label>
                                    <input type="number" class="custom-input !py-2" value="${p.progress}" onchange="window.updateProject('${d.id}', 'progress', parseInt(this.value))">
                                </div>
                                <div class="flex-1 min-w-[150px]">
                                    <label class="text-[10px] text-gray-500 uppercase font-black mb-1 block">상세 단계</label>
                                    <input type="text" class="custom-input !py-2" value="${p.phase || ''}" placeholder="기획 / 디자인 / 개발 중..." onchange="window.updateProject('${d.id}', 'phase', this.value)">
                                </div>
                                <div class="pt-5">
                                    <button onclick="window.delData('projects', '${d.id}')" class="w-10 h-10 rounded-xl bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white transition-all"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('admin-project-list').innerHTML = html;
            });

            // 3. Deposits
            onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'deposits'), (snap) => {
                let html = '';
                snap.forEach(d => {
                    const dep = d.data();
                    const isDone = (dep.status || '').toLowerCase() === 'complete';
                    html += `
                        <tr class="border-b border-white/5 hover:bg-white/1">
                            <td class="p-5 font-bold text-gray-100">${dep.name}<br><span class="text-[10px] text-gray-600">${dep.phone || '-'}</span></td>
                            <td class="p-5 text-gray-400 text-xs">${dep.type}</td>
                            <td class="p-5">
                                <button onclick="window.toggleDepositStatus('${d.id}', '${dep.status}')" class="px-3 py-1 rounded-full text-[10px] font-black uppercase ${isDone ? 'bg-green-500/10 text-green-500' : 'bg-yellow-500/10 text-yellow-500'}">
                                    ${isDone ? '입금완료' : '입금대기'}
                                </button>
                            </td>
                            <td class="p-5 text-gray-600 text-[11px]">${dep.createdAt ? new Date(dep.createdAt.seconds * 1000).toLocaleDateString() : '-'}</td>
                            <td class="p-5 text-right"><button onclick="window.delData('deposits', '${d.id}')" class="text-gray-700 hover:text-red-500"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    `;
                });
                document.getElementById('deposit-table-body').innerHTML = html;
            });

            // 4. Main Config (Notice)
            getDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'configs', 'mainSettings')).then(snap => {
                if(snap.exists()) document.getElementById('main-notice-text').value = snap.data().noticeTitle || '';
            });
        }

        window.saveMainSettings = async () => {
            const txt = document.getElementById('main-notice-text').value;
            await setDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'configs', 'mainSettings'), {
                noticeTitle: txt,
                updatedAt: serverTimestamp()
            }, { merge: true });
            showToast('공지사항이 업데이트 되었습니다.');
        };

        window.addProject = async () => {
            await addDoc(collection(db, 'artifacts', currentAppId, 'public', 'data', 'projects'), {
                name: '새로운 프로젝트',
                progress: 0,
                phase: '기획 단계',
                createdAt: serverTimestamp()
            });
            showToast('신규 프로젝트를 추가했습니다.');
        };

        window.updateProject = async (id, field, val) => {
            await updateDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'projects', id), { [field]: val });
        };

        window.toggleDepositStatus = async (id, current) => {
            const nextStatus = (current || '').toLowerCase() === 'complete' ? 'pending' : 'complete';
            await updateDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'deposits', id), { status: nextStatus });
        };

        window.delData = async (col, id) => {
            if(confirm('데이터를 영구적으로 삭제하시겠습니까?')) {
                await deleteDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', col, id));
                showToast('삭제 완료');
            }
        };

        async function sendNotificationEmail(data) {
            const adminEmail = document.getElementById('admin-email').value;
            const params = {
                to_email: adminEmail,
                client_name: data.name,
                client_contact: data.contact,
                category: data.category,
                message: data.content,
                sent_at: new Date().toLocaleString()
            };
            try {
                await emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, params);
                showToast(`[${data.name}] 알림 메일이 전송되었습니다.`);
            } catch (err) {
                console.error("EmailJS Error:", err);
            }
        }

        window.resendQuote = async (id) => {
            const snap = await getDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'quotes', id));
            if (snap.exists()) {
                sendNotificationEmail(snap.data());
            }
        };

        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-link').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-'+id).classList.add('active');
        };
    </script>
</body>
</html>
