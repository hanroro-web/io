<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한로로 관리자 대시보드 | 보안 및 복구 센터</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@100..900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #05020a; color: #fff; min-height: 100vh; }
        .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 1.5rem; padding: 2rem; }
        .input-dark { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem; padding: 1rem; width: 100%; color: white; outline: none; }
        .input-dark:focus { border-color: #8a4fff; }
        .btn-primary { background: #8a4fff; color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: bold; transition: all 0.2s; cursor: pointer; border: none; }
        .btn-primary:hover { background: #763ee6; transform: translateY(-2px); }
        .btn-edit { color: #a78bfa; font-size: 10px; font-weight: bold; margin-right: 8px; }
        .btn-delete { color: #ef4444; font-size: 10px; font-weight: bold; }
        .btn-restore { color: #10b981; font-size: 10px; font-weight: bold; margin-right: 8px; }
        
        #login-overlay { position: fixed; inset: 0; background: #05020a; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-box { width: 100%; max-width: 400px; background: #0f0a1f; border: 1px solid rgba(138, 79, 255, 0.2); border-radius: 24px; padding: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .hidden-content { display: none; }
        .trash-badge { background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: bold; }
    </style>
</head>
<body class="p-4 sm:p-10">
    <!-- Login Overlay -->
    <div id="login-overlay">
        <div class="login-box">
            <div class="text-center mb-8">
                <i class="fas fa-shield-alt text-4xl text-purple-500 mb-4"></i>
                <h2 class="text-2xl font-black uppercase tracking-tighter text-white">Admin Login</h2>
            </div>
            <form id="login-form" class="space-y-4">
                <input type="text" id="admin-id" class="input-dark" placeholder="ID" required>
                <input type="password" id="admin-pw" class="input-dark" placeholder="Password" required>
                <button type="submit" class="btn-primary w-full mt-4 py-4">인증 및 접속</button>
                <p id="login-error" class="text-red-500 text-[10px] text-center mt-2 hidden">정보가 일치하지 않습니다.</p>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="max-w-7xl mx-auto hidden-content">
        <header class="mb-12 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-black mb-2 uppercase tracking-tighter text-purple-400">Control Panel</h1>
                <p class="text-gray-500 text-sm font-medium">90일 데이터 보관 정책 적용됨</p>
            </div>
            <button onclick="logout()" class="text-[10px] text-gray-400 hover:text-white border border-white/10 px-4 py-2 rounded-lg">로그아웃</button>
        </header>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Left: Forms -->
            <div class="lg:col-span-1 space-y-6">
                <div class="card">
                    <h2 id="project-form-title" class="text-lg font-bold mb-6 flex items-center gap-2"><i class="fas fa-edit text-purple-500"></i> 프로젝트 관리</h2>
                    <input type="hidden" id="edit-proj-id">
                    <div class="space-y-3">
                        <input type="text" id="proj-name" placeholder="고객명" class="input-dark text-xs">
                        <input type="number" id="proj-progress" placeholder="진척률(%)" class="input-dark text-xs">
                        <input type="text" id="proj-phase" placeholder="단계" class="input-dark text-xs">
                        <input type="text" id="proj-status" placeholder="상세 상태" class="input-dark text-xs">
                        <button onclick="saveProject()" class="btn-primary w-full py-3 text-xs mt-2">저장</button>
                    </div>
                </div>

                <div class="card">
                    <h2 id="notice-form-title" class="text-lg font-bold mb-6 flex items-center gap-2"><i class="fas fa-bullhorn text-purple-500"></i> 공지사항</h2>
                    <input type="hidden" id="edit-notice-id">
                    <textarea id="notice-input" placeholder="내용 입력" class="input-dark h-32 text-xs mb-3"></textarea>
                    <button onclick="saveNotice()" class="btn-primary w-full py-3 text-xs">저장</button>
                </div>
            </div>

            <!-- Middle/Right: Lists -->
            <div class="lg:col-span-2 space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="card">
                        <h2 class="text-sm font-bold mb-4 opacity-50">진행 중인 프로젝트</h2>
                        <div id="project-list" class="space-y-3 max-h-[300px] overflow-y-auto pr-2"></div>
                    </div>
                    <div class="card">
                        <h2 class="text-sm font-bold mb-4 opacity-50">상담 신청</h2>
                        <div id="lead-list" class="space-y-3 max-h-[300px] overflow-y-auto pr-2"></div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-sm font-bold mb-4 opacity-50">공지사항 내역</h2>
                    <div id="notice-list" class="space-y-3 max-h-[250px] overflow-y-auto"></div>
                </div>

                <!-- Trash Section -->
                <div class="card border-dashed border-red-500/20 bg-red-500/5">
                    <h2 class="text-sm font-bold mb-4 flex items-center gap-2 text-red-400">
                        <i class="fas fa-trash-alt"></i> 휴지통 (90일 보관)
                    </h2>
                    <p class="text-[9px] text-gray-500 mb-4">삭제된 항목은 90일 후 자동 파기됩니다.</p>
                    <div id="trash-list" class="space-y-2 max-h-[300px] overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, deleteDoc, updateDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBkWgHnnHTKaOfHmgt7P-OwptraKcwEXvI",
          authDomain: "hanroro-web.firebaseapp.com",
          projectId: "hanroro-web",
          storageBucket: "hanroro-web.firebasestorage.app",
          messagingSenderId: "461514865624",
          appId: "1:461514865624:web:4ab6ad23c2e771b426d0ad",
          measurementId: "G-8L3EFM6PY8"
        };

        const appId = "hanroro-official-service";
        const ADMIN_ID = "hanroro";
        const ADMIN_PW = "gksfhfh00@@";
        let db;

        // Auth handling
        window.addEventListener('load', () => {
            if(sessionStorage.getItem('hanroro_admin_auth') === 'true') showDashboard();
        });

        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            if(document.getElementById('admin-id').value === ADMIN_ID && document.getElementById('admin-pw').value === ADMIN_PW) {
                sessionStorage.setItem('hanroro_admin_auth', 'true');
                showDashboard();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        window.logout = () => { sessionStorage.removeItem('hanroro_admin_auth'); location.reload(); };

        async function showDashboard() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-content').classList.remove('hidden-content');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            const auth = getAuth(app);
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (u) => { if(u) loadAll(); });
        }

        // --- Logic: Trash & Expiry ---

        // Move to Trash instead of direct delete
        window.moveToTrash = async (colName, docId) => {
            if(!confirm('휴지통으로 이동하시겠습니까? (90일 보관)')) return;
            
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', colName, docId);
            const snap = await getDoc(docRef);
            
            if(snap.exists()) {
                const data = snap.data();
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 90);

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'trash'), {
                    originalCollection: colName,
                    originalData: data,
                    deletedAt: serverTimestamp(),
                    expiresAt: expiryDate,
                    type: colName === 'projects' ? '프로젝트' : colName === 'notices' ? '공지' : '상담신청'
                });

                await deleteDoc(docRef);
            }
        };

        window.restoreFromTrash = async (trashId) => {
            const trashRef = doc(db, 'artifacts', appId, 'public', 'data', 'trash', trashId);
            const snap = await getDoc(trashRef);
            if(snap.exists()) {
                const { originalCollection, originalData } = snap.data();
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', originalCollection), originalData);
                await deleteDoc(trashRef);
                alert('복구되었습니다.');
            }
        };

        window.permanentDelete = async (trashId) => {
            if(confirm('이 항목을 영구적으로 삭제하시겠습니까? 복구할 수 없습니다.')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trash', trashId));
            }
        };

        // --- Standard CRUD ---
        window.saveProject = async () => {
            const id = document.getElementById('edit-proj-id').value;
            const data = {
                name: document.getElementById('proj-name').value,
                progress: parseInt(document.getElementById('proj-progress').value || 0),
                phase: document.getElementById('proj-phase').value,
                status: document.getElementById('proj-status').value,
                updatedAt: serverTimestamp()
            };
            if(id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', id), data);
            else { data.createdAt = serverTimestamp(); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), data); }
            resetProjForm();
        };

        window.editProject = (id, n, p, ph, s) => {
            document.getElementById('edit-proj-id').value = id;
            document.getElementById('proj-name').value = n;
            document.getElementById('proj-progress').value = p;
            document.getElementById('proj-phase').value = ph;
            document.getElementById('proj-status').value = s;
        };

        function resetProjForm() { ['edit-proj-id','proj-name','proj-progress','proj-phase','proj-status'].forEach(i => document.getElementById(i).value=''); }

        window.saveNotice = async () => {
            const id = document.getElementById('edit-notice-id').value;
            const text = document.getElementById('notice-input').value;
            if(id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notices', id), { text, updatedAt: serverTimestamp() });
            else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notices'), { text, createdAt: serverTimestamp() });
            document.getElementById('edit-notice-id').value = ''; document.getElementById('notice-input').value = '';
        };

        window.editNotice = (id, t) => { document.getElementById('edit-notice-id').value = id; document.getElementById('notice-input').value = t; };

        // --- Data Loading ---
        function loadAll() {
            const render = (col, elId, template) => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', col), (s) => {
                    let h = ''; s.forEach(d => h += template(d.id, d.data()));
                    document.getElementById(elId).innerHTML = h || '<p class="text-[10px] text-gray-600">내역 없음</p>';
                });
            };

            render('projects', 'project-list', (id, p) => `
                <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg border border-white/5">
                    <span class="text-xs font-bold">${p.name}</span>
                    <div>
                        <button onclick="editProject('${id}','${p.name}',${p.progress},'${p.phase}','${p.status}')" class="btn-edit">수정</button>
                        <button onclick="moveToTrash('projects', '${id}')" class="btn-delete">삭제</button>
                    </div>
                </div>
            `);

            render('notices', 'notice-list', (id, n) => `
                <div class="bg-white/5 p-3 rounded-lg border border-white/5 mb-2">
                    <p class="text-[10px] text-gray-400 line-clamp-1">${n.text}</p>
                    <div class="mt-2">
                        <button onclick="editNotice('${id}', '${n.text.replace(/'/g, "\\'")}')" class="btn-edit">수정</button>
                        <button onclick="moveToTrash('notices', '${id}')" class="btn-delete">삭제</button>
                    </div>
                </div>
            `);

            render('leads', 'lead-list', (id, l) => `
                <div class="bg-white/5 p-3 rounded-lg flex justify-between items-center">
                    <span class="text-[10px] font-bold">${l.name}</span>
                    <button onclick="moveToTrash('leads', '${id}')" class="btn-delete">삭제</button>
                </div>
            `);

            // Trash loading with 90-day filter (client-side)
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'trash'), (s) => {
                const list = document.getElementById('trash-list');
                let h = '';
                const now = new Date();
                
                s.forEach(d => {
                    const t = d.data();
                    const expiresAt = t.expiresAt?.toDate();
                    
                    // 만료된 항목은 표시하지 않음 (서버리스 환경이라 여기서 필터링하거나 별도 스케줄러 필요)
                    if(expiresAt && expiresAt < now) return; 

                    const name = t.originalData.name || t.originalData.text?.substring(0,10) || '항목';
                    h += `
                        <div class="bg-black/40 p-3 rounded-xl border border-red-500/10 flex justify-between items-center">
                            <div>
                                <span class="trash-badge">${t.type}</span>
                                <span class="text-[10px] ml-2 font-medium">${name}...</span>
                            </div>
                            <div>
                                <button onclick="restoreFromTrash('${d.id}')" class="btn-restore">복구</button>
                                <button onclick="permanentDelete('${d.id}')" class="btn-delete">영구 삭제</button>
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = h || '<p class="text-[10px] text-gray-600 text-center py-4">비어 있음</p>';
            });
        }
    </script>
</body>
</html>
