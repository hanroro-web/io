<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HANRORO | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@100..900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #05020a; color: #ffffff; }
        .glass-panel { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); }
        .sidebar-link { transition: all 0.3s ease; }
        .sidebar-link.active { background: rgba(138, 79, 255, 0.15); color: #a78bfa; border-left: 3px solid #8a4fff; }
        .custom-input { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 10px 14px; color: white; width: 100%; outline: none; }
        .custom-input:focus { border-color: #8a4fff; }
        .btn-primary { background: #8a4fff; color: white; padding: 10px 20px; border-radius: 8px; font-weight: bold; transition: all 0.3s ease; }
        .btn-primary:hover { background: #7c3aed; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-64 border-r border-white/5 flex flex-col">
        <div class="p-8">
            <div class="text-xl font-black text-purple-500 tracking-tighter uppercase">HANRORO ADMIN</div>
        </div>
        <nav class="flex-1 px-4 space-y-2">
            <button onclick="showTab('deposits-tab')" class="sidebar-link w-full text-left px-4 py-3 rounded-lg text-sm font-bold flex items-center gap-3 active" id="btn-deposits-tab">
                <i class="fas fa-wallet w-5"></i> 입금 관리
            </button>
            <button onclick="showTab('projects-tab')" class="sidebar-link w-full text-left px-4 py-3 rounded-lg text-sm font-bold flex items-center gap-3" id="btn-projects-tab">
                <i class="fas fa-tasks w-5"></i> 프로젝트 관리
            </button>
            <button onclick="showTab('quotes-tab')" class="sidebar-link w-full text-left px-4 py-3 rounded-lg text-sm font-bold flex items-center gap-3" id="btn-quotes-tab">
                <i class="fas fa-comment-dots w-5"></i> 상담 신청
            </button>
            <button onclick="showTab('settings-tab')" class="sidebar-link w-full text-left px-4 py-3 rounded-lg text-sm font-bold flex items-center gap-3" id="btn-settings-tab">
                <i class="fas fa-cog w-5"></i> 사이트 설정
            </button>
        </nav>
        <div class="p-6">
            <!-- 요청사항: 로그아웃 버튼으로 변경 -->
            <button onclick="handleLogout()" class="w-full py-3 rounded-lg bg-red-500/10 text-red-500 text-xs font-bold hover:bg-red-500/20 transition-all">로그아웃</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-10 overflow-y-auto">
        <!-- Deposits Tab -->
        <section id="deposits-tab" class="tab-content active">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-3xl font-black mb-2">입금 현황 관리</h2>
                    <p class="text-gray-500 text-sm">입금 내역을 확인하고 상태를 변경할 수 있습니다.</p>
                </div>
            </div>
            <div class="glass-panel rounded-2xl overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-white/5 border-b border-white/5 text-gray-400">
                        <tr>
                            <th class="p-4 font-bold">이름/업체</th>
                            <th class="p-4 font-bold">연락처</th>
                            <th class="p-4 font-bold">플랜</th>
                            <th class="p-4 font-bold">상태</th>
                            <th class="p-4 font-bold">액션</th>
                        </tr>
                    </thead>
                    <tbody id="deposit-table-body"></tbody>
                </table>
            </div>
        </section>

        <!-- Projects Tab -->
        <section id="projects-tab" class="tab-content">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-3xl font-black mb-2">프로젝트 관리</h2>
                    <p class="text-gray-500 text-sm">진행 중인 프로젝트를 추가하거나 수정합니다.</p>
                </div>
                <button onclick="openProjectModal()" class="btn-primary">신규 추가</button>
            </div>
            <div class="grid grid-cols-1 gap-4" id="project-admin-list"></div>
        </section>

        <!-- Quotes Tab -->
        <section id="quotes-tab" class="tab-content">
            <div class="mb-8">
                <h2 class="text-3xl font-black mb-2">상담 신청 목록</h2>
                <p class="text-gray-500 text-sm">유입된 상담 및 견적 신청 내역입니다.</p>
            </div>
            <div class="glass-panel rounded-2xl overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-white/5 border-b border-white/5 text-gray-400">
                        <tr>
                            <th class="p-4 font-bold">구분</th>
                            <th class="p-4 font-bold">신청자</th>
                            <th class="p-4 font-bold">연락처</th>
                            <th class="p-4 font-bold">내용</th>
                            <th class="p-4 font-bold">날짜</th>
                        </tr>
                    </thead>
                    <tbody id="quote-table-body"></tbody>
                </table>
            </div>
        </section>

        <!-- Settings Tab -->
        <section id="settings-tab" class="tab-content">
            <div class="mb-8">
                <h2 class="text-3xl font-black mb-2">사이트 설정</h2>
                <p class="text-gray-500 text-sm">홈페이지의 전역 설정을 변경합니다.</p>
            </div>
            
            <div class="max-w-2xl space-y-8">
                <!-- 노티스 제목 설정 (요청사항 반영) -->
                <div class="glass-panel p-8 rounded-2xl space-y-4">
                    <div>
                        <h4 class="text-lg font-bold mb-1">공지사항 관리</h4>
                        <p class="text-gray-500 text-xs">메인페이지 하단 티커에 노출되는 노티스 제목입니다.</p>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">노티스 제목 (1줄)</label>
                        <input type="text" id="setting-notice-title" class="custom-input" placeholder="공지사항 내용을 입력하세요.">
                    </div>
                    <button onclick="saveMainSettings()" class="btn-primary w-full mt-4">설정 저장하기</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Project Modal -->
    <div id="project-modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm hidden items-center justify-center p-6">
        <div class="bg-[#0f0a1f] border border-white/10 w-full max-w-md rounded-2xl p-8">
            <h3 class="text-xl font-bold mb-6">프로젝트 정보 입력</h3>
            <div class="space-y-4">
                <input type="text" id="p-name" class="custom-input" placeholder="프로젝트명">
                <input type="text" id="p-phase" class="custom-input" placeholder="현재 단계 (예: 기획중)">
                <input type="number" id="p-progress" class="custom-input" placeholder="진행률 (%)" min="0" max="100">
                <div class="flex gap-3 mt-6">
                    <button onclick="closeProjectModal()" class="flex-1 py-3 rounded-lg bg-white/5 font-bold">취소</button>
                    <button onclick="saveProject()" class="flex-1 py-3 rounded-lg bg-purple-600 font-bold">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, setDoc, addDoc, deleteDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBkWgHnnHTKaOfHmgt7P-OwptraKcwEXvI", 
            authDomain: "hanroro-web.firebaseapp.app", 
            projectId: "hanroro-web", 
            appId: "1:461514865624:web:4ab6ad23c2e771b426d0ad" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const currentAppId = "hanroro-official-service";

        window.showTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-link').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('active');
        };

        // 로그아웃 핸들러
        window.handleLogout = async () => {
            if(confirm('로그아웃 하시겠습니까?')) {
                try {
                    await signOut(auth);
                    location.href = 'index.html'; // 로그아웃 후 메인으로 리다이렉트
                } catch (error) {
                    console.error("로그아웃 실패:", error);
                }
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // 입금 관리 데이터
                onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'deposits'), (snap) => {
                    let html = '';
                    snap.forEach(d => {
                        const item = d.data();
                        html += `<tr class="border-b border-white/5 hover:bg-white/5 transition-all">
                            <td class="p-4 font-bold">${item.name}</td>
                            <td class="p-4 text-gray-400">${item.phone || '-'}</td>
                            <td class="p-4"><span class="px-2 py-1 rounded bg-purple-500/10 text-purple-400 text-[10px] font-bold uppercase">${item.type}</span></td>
                            <td class="p-4">
                                <span class="px-2 py-1 rounded text-[10px] font-bold ${item.status === 'complete' ? 'bg-green-500/10 text-green-500' : 'bg-yellow-500/10 text-yellow-500'}">
                                    ${item.status === 'complete' ? '완료' : '대기중'}
                                </span>
                            </td>
                            <td class="p-4">
                                <button onclick="toggleDepositStatus('${d.id}', '${item.status}')" class="text-xs font-bold text-gray-400 hover:text-white mr-3">상태변경</button>
                                <button onclick="deleteData('deposits', '${d.id}')" class="text-xs font-bold text-red-500 hover:text-red-400">삭제</button>
                            </td>
                        </tr>`;
                    });
                    document.getElementById('deposit-table-body').innerHTML = html || '<tr><td colspan="5" class="p-10 text-center text-gray-500">데이터가 없습니다.</td></tr>';
                });

                // 프로젝트 관리 데이터
                onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'projects'), (snap) => {
                    let html = '';
                    snap.forEach(d => {
                        const p = d.data();
                        html += `<div class="glass-panel p-6 rounded-2xl flex justify-between items-center">
                            <div>
                                <h4 class="font-bold mb-1">${p.name}</h4>
                                <p class="text-xs text-gray-500">${p.phase} | ${p.progress}%</p>
                            </div>
                            <button onclick="deleteData('projects', '${d.id}')" class="w-10 h-10 rounded-lg bg-red-500/10 text-red-500 flex items-center justify-center hover:bg-red-500/20 transition-all">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>`;
                    });
                    document.getElementById('project-admin-list').innerHTML = html || '<p class="p-10 text-center text-gray-500">등록된 프로젝트가 없습니다.</p>';
                });

                // 상담 신청 데이터
                onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'quotes'), (snap) => {
                    let html = '';
                    snap.forEach(d => {
                        const q = d.data();
                        const date = q.createdAt ? new Date(q.createdAt.seconds * 1000).toLocaleDateString() : '-';
                        html += `<tr class="border-b border-white/5 hover:bg-white/5">
                            <td class="p-4 font-bold text-purple-400 text-xs">${q.category || '일반'}</td>
                            <td class="p-4 font-bold">${q.name}</td>
                            <td class="p-4 text-gray-400">${q.contact}</td>
                            <td class="p-4 text-gray-500 max-w-xs truncate">${q.content}</td>
                            <td class="p-4 text-gray-600 text-[10px]">${date}</td>
                        </tr>`;
                    });
                    document.getElementById('quote-table-body').innerHTML = html || '<tr><td colspan="5" class="p-10 text-center text-gray-500">상담 내역이 없습니다.</td></tr>';
                });

                // 사이트 설정
                onSnapshot(doc(db, 'artifacts', currentAppId, 'public', 'data', 'configs', 'mainSettings'), (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        const input = document.getElementById('setting-notice-title');
                        if(input) input.value = data.noticeTitle || "";
                    }
                });

            } else {
                signInAnonymously(auth);
            }
        });

        // 기능 함수들
        window.toggleDepositStatus = async (id, current) => {
            const next = current === 'complete' ? 'pending' : 'complete';
            await updateDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'deposits', id), { status: next });
        };

        window.deleteData = async (col, id) => {
            if(confirm('정말 삭제하시겠습니까?')) {
                await deleteDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', col, id));
            }
        };

        window.saveMainSettings = async () => {
            const noticeTitle = document.getElementById('setting-notice-title').value;
            try {
                await setDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'configs', 'mainSettings'), {
                    noticeTitle: noticeTitle,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                alert('공지사항 설정이 저장되었습니다.');
            } catch (e) {
                alert('저장 중 오류가 발생했습니다.');
            }
        };

        window.openProjectModal = () => document.getElementById('project-modal').classList.replace('hidden', 'flex');
        window.closeProjectModal = () => document.getElementById('project-modal').classList.replace('flex', 'hidden');

        window.saveProject = async () => {
            const name = document.getElementById('p-name').value;
            const phase = document.getElementById('p-phase').value;
            const progress = document.getElementById('p-progress').value;
            if(!name || !phase) return alert('정보를 입력하세요.');
            
            await addDoc(collection(db, 'artifacts', currentAppId, 'public', 'data', 'projects'), {
                name, phase, progress: parseInt(progress), createdAt: serverTimestamp()
            });
            closeProjectModal();
        };

    </script>
</body>
</html>
